<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Collecting Data â€“ alphasignal533</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap-ace74d340a4791061218a60df7c0f5e0.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="./index.html">
    <span class="navbar-title">alphasignal533</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="./index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="./about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/im-Tree/Fintech533-website"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">On this page</h2>
   
  <ul>
  <li><a href="#yr-yield-spread" id="toc-yr-yield-spread" class="nav-link active" data-scroll-target="#yr-yield-spread">10-2Yr Yield Spread</a></li>
  <li><a href="#calculate-indicators-and-scores" id="toc-calculate-indicators-and-scores" class="nav-link" data-scroll-target="#calculate-indicators-and-scores">Calculate Indicators and Scores</a></li>
  <li><a href="#visualization" id="toc-visualization" class="nav-link" data-scroll-target="#visualization">Visualization</a></li>
  <li><a href="#backtest-strategy-function" id="toc-backtest-strategy-function" class="nav-link" data-scroll-target="#backtest-strategy-function">Backtest Strategy Function</a></li>
  <li><a href="#implement-startegy" id="toc-implement-startegy" class="nav-link" data-scroll-target="#implement-startegy">Implement Startegy</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Collecting Data</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<div id="1c7638839472fa1d" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-28T23:18:05.782544Z&quot;,&quot;start_time&quot;:&quot;2025-04-28T23:18:03.581656Z&quot;}" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> io</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> requests</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> shinybroker <span class="im">as</span> sb</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> bs4 <span class="im">import</span> BeautifulSoup</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="e258d462d7f85257" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-28T23:18:08.924553Z&quot;,&quot;start_time&quot;:&quot;2025-04-28T23:18:08.919508Z&quot;}" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>asset_symbols <span class="op">=</span> [<span class="st">'AAPL'</span>, <span class="st">'MSFT'</span>, <span class="st">'JPM'</span>, <span class="st">'XOM'</span>, <span class="st">'JNJ'</span>, <span class="st">'PG'</span>, <span class="st">'NVDA'</span>, <span class="st">'CAT'</span>, <span class="st">'HD'</span>, <span class="st">'AMZN'</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="a59bcedd9e962d15" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-28T23:18:11.020391Z&quot;,&quot;start_time&quot;:&quot;2025-04-28T23:18:11.014438Z&quot;}" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calc_trd_prd(timestamps, freq <span class="op">=</span> <span class="st">'M'</span>):</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> freq <span class="op">==</span> <span class="st">'W'</span>:</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [ts.isocalendar()[<span class="dv">0</span>] <span class="op">+</span> ts.isocalendar()[<span class="dv">1</span>] <span class="op">/</span> <span class="dv">100</span> <span class="cf">for</span> ts <span class="kw">in</span> timestamps]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> freq <span class="op">==</span> <span class="st">'M'</span>:</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> [ts.year <span class="op">+</span> ts.month <span class="op">/</span> <span class="dv">100</span> <span class="cf">for</span> ts <span class="kw">in</span> timestamps]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="3af73cd04510b655" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-28T23:29:00.370826Z&quot;,&quot;start_time&quot;:&quot;2025-04-28T23:28:07.635230Z&quot;}" data-execution_count="11">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> os</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>root <span class="op">=</span> os.getcwd()</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>data_root <span class="op">=</span> os.path.join(root, <span class="st">'HistoryData'</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> os.path.exists(data_root):</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    os.makedirs(data_root)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'HistoryData directory created'</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'HistoryData folder already exists'</span>)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>daily_data_dict <span class="op">=</span> {}</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>hourly_data_dict <span class="op">=</span> {}</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>daily_iv_dict <span class="op">=</span> {}</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> symbol <span class="kw">in</span> asset_symbols:</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss"> Fetching: </span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>    contract <span class="op">=</span> sb.Contract({</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">'symbol'</span>: symbol,</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">'secType'</span>: <span class="st">"STK"</span>,</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="st">'exchange'</span>: <span class="st">"SMART"</span>,</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">'currency'</span>: <span class="st">"USD"</span></span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    })</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    df_daily <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        contract<span class="op">=</span>contract,</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a>        barSizeSetting<span class="op">=</span><span class="st">"1 day"</span>,</span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>        durationStr<span class="op">=</span><span class="st">"8 M"</span></span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>    )[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    df_hourly <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        contract<span class="op">=</span>contract,</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a>        barSizeSetting<span class="op">=</span><span class="st">"1 hour"</span>,</span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>        durationStr<span class="op">=</span><span class="st">"8 M"</span></span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    )[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    df_daily_iv <span class="op">=</span> sb.fetch_historical_data(</span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>        contract<span class="op">=</span>contract,</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>        barSizeSetting<span class="op">=</span><span class="st">"1 day"</span>,</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        durationStr<span class="op">=</span><span class="st">"10 M"</span>,</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        whatToShow<span class="op">=</span><span class="st">"OPTION_IMPLIED_VOLATILITY"</span></span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>    )[<span class="st">'hst_dta'</span>]</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    df_daily[<span class="st">'trd_prd'</span>] <span class="op">=</span> calc_trd_prd(df_daily[<span class="st">'timestamp'</span>])</span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    df_hourly[<span class="st">'trd_prd'</span>] <span class="op">=</span> calc_trd_prd(df_hourly[<span class="st">'timestamp'</span>])</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a>    df_daily_iv[<span class="st">'trd_prd'</span>] <span class="op">=</span> calc_trd_prd(df_daily_iv[<span class="st">'timestamp'</span>])</span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    df_daily.to_csv(os.path.join(data_root, <span class="ss">f'</span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss">_daily.csv'</span>))</span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a>    df_daily.to_csv(os.path.join(data_root, <span class="ss">f'</span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss">_hourly.csv'</span>))</span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    df_daily.to_csv(os.path.join(data_root, <span class="ss">f'</span><span class="sc">{</span>symbol<span class="sc">}</span><span class="ss">_iv.csv'</span>))</span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>    daily_data_dict[symbol] <span class="op">=</span> df_daily</span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a>    hourly_data_dict[symbol] <span class="op">=</span> df_hourly</span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>    daily_iv_dict[symbol] <span class="op">=</span> df_daily_iv</span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(daily_data_dict)</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(hourly_data_dict)</span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(daily_iv_dict)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>HistoryData folder already exists

 Fetching: AAPL

 Fetching: MSFT

 Fetching: JPM

 Fetching: XOM

 Fetching: JNJ

 Fetching: PG

 Fetching: NVDA

 Fetching: CAT

 Fetching: HD

 Fetching: AMZN
{'AAPL':       timestamp    open    high     low   close    volume      wap  barCount  \
0    2024-09-03  228.55  229.00  221.17  222.77  27800491  224.005    155414   
1    2024-09-04  221.70  221.78  217.48  220.85  27586896  219.774    142977   
2    2024-09-05  221.73  225.48  221.52  222.38  21549150  223.325    115868   
3    2024-09-06  224.00  225.24  219.77  220.82  26076978  221.990    133485   
4    2024-09-09  220.83  221.27  216.71  220.91  44734345  219.098    222732   
..          ...     ...     ...     ...     ...       ...      ...       ...   
158  2025-04-22  196.00  201.59  195.97  199.74  29453698  199.095    152437   
159  2025-04-23  205.99  208.00  202.79  204.60  30480172  205.506    168370   
160  2025-04-24  204.94  208.83  202.94  208.37  21895737  206.480    125147   
161  2025-04-25  206.35  209.75  206.20  209.28  19849630  208.137    108876   
162  2025-04-28  210.06  211.50  207.46  210.14  19057291  209.499    101708   

     trd_prd  
0    2024.09  
1    2024.09  
2    2024.09  
3    2024.09  
4    2024.09  
..       ...  
158  2025.04  
159  2025.04  
160  2025.04  
161  2025.04  
162  2025.04  

[163 rows x 9 columns], 'MSFT':       timestamp    open    high     low   close   volume      wap  barCount  \
0    2024-09-03  417.95  419.88  407.03  409.44  7850424  412.829     46056   
1    2024-09-04  405.79  411.24  404.37  408.90  7333880  408.382     43040   
2    2024-09-05  407.62  413.10  406.13  408.39  6651606  408.910     41539   
3    2024-09-06  409.49  410.65  400.80  401.70  7475042  403.583     42439   
4    2024-09-09  407.12  408.65  402.15  405.72  7376986  404.838     37556   
..          ...     ...     ...     ...     ...      ...      ...       ...   
158  2025-04-22  363.27  367.77  359.86  366.82  9018960  364.499     55892   
159  2025-04-23  375.92  380.39  373.02  374.39  9972156  376.666     63211   
160  2025-04-24  375.41  388.45  375.19  387.30  8506978  384.121     56708   
161  2025-04-25  387.00  392.16  384.60  391.85  7529031  389.041     50815   
162  2025-04-28  392.08  392.74  386.63  391.16  7252265  389.873     47384   

     trd_prd  
0    2024.09  
1    2024.09  
2    2024.09  
3    2024.09  
4    2024.09  
..       ...  
158  2025.04  
159  2025.04  
160  2025.04  
161  2025.04  
162  2025.04  

[163 rows x 9 columns], 'JPM':       timestamp    open    high     low   close   volume      wap  barCount  \
0    2024-09-03  222.30  224.10  219.24  220.30  4810695  221.393     28856   
1    2024-09-04  221.04  222.07  217.21  219.33  4067940  219.735     25588   
2    2024-09-05  220.15  220.80  216.03  217.63  4357670  218.028     24919   
3    2024-09-06  217.60  218.74  211.09  212.46  4046060  214.139     24690   
4    2024-09-09  215.19  218.15  214.17  216.81  4024539  216.637     23177   
..          ...     ...     ...     ...     ...      ...      ...       ...   
158  2025-04-22  231.98  235.99  231.37  235.59  4658189  234.107     27604   
159  2025-04-23  240.22  246.79  240.00  240.88  7054055  242.978     43390   
160  2025-04-24  239.74  245.47  237.58  244.64  5115597  242.897     33844   
161  2025-04-25  244.65  245.62  241.75  243.55  3568676  243.406     22388   
162  2025-04-28  244.56  246.84  240.84  243.22  3507143  242.896     21253   

     trd_prd  
0    2024.09  
1    2024.09  
2    2024.09  
3    2024.09  
4    2024.09  
..       ...  
158  2025.04  
159  2025.04  
160  2025.04  
161  2025.04  
162  2025.04  

[163 rows x 9 columns], 'XOM':       timestamp    open    high     low   close    volume      wap  barCount  \
0    2024-09-03  115.84  116.09  114.04  115.47   7824922  115.224     41167   
1    2024-09-04  115.29  116.15  113.97  114.06   7133340  114.881     33888   
2    2024-09-05  115.07  115.28  113.07  113.17   6949548  113.966     35085   
3    2024-09-06  113.59  114.18  111.73  112.64   7212147  112.635     38243   
4    2024-09-09  112.87  116.15  112.66  115.01  13655028  115.040     69188   
..          ...     ...     ...     ...     ...       ...      ...       ...   
158  2025-04-22  106.14  108.94  106.14  108.30   6290010  107.832     37410   
159  2025-04-23  108.81  109.30  106.47  107.37   8462417  107.466     51980   
160  2025-04-24  107.97  108.88  106.96  108.63   5167225  108.137     29472   
161  2025-04-25  108.14  108.76  107.42  108.57   4718570  108.237     28312   
162  2025-04-28  108.75  109.25  107.68  108.63   5166576  108.488     30815   

     trd_prd  
0    2024.09  
1    2024.09  
2    2024.09  
3    2024.09  
4    2024.09  
..       ...  
158  2025.04  
159  2025.04  
160  2025.04  
161  2025.04  
162  2025.04  

[163 rows x 9 columns], 'JNJ':       timestamp    open    high     low   close   volume      wap  barCount  \
0    2024-09-03  165.24  167.81  164.77  167.16  3293639  166.932     18880   
1    2024-09-04  167.81  168.85  166.04  167.36  3716323  167.402     20633   
2    2024-09-05  167.20  167.37  164.83  164.99  2201018  165.785     13344   
3    2024-09-06  165.18  165.94  164.12  164.38  2224976  164.833     13398   
4    2024-09-09  164.84  167.41  164.47  166.61  3433668  166.536     17418   
..          ...     ...     ...     ...     ...      ...      ...       ...   
158  2025-04-22  157.55  158.72  156.26  157.75  3298219  157.571     20733   
159  2025-04-23  156.49  157.10  154.33  155.38  4858946  155.517     32761   
160  2025-04-24  155.80  155.90  153.44  154.93  4663728  154.437     23967   
161  2025-04-25  154.32  154.90  152.45  154.58  4862818  153.821     30553   
162  2025-04-28  155.50  155.81  153.82  155.35  2861563  155.074     17308   

     trd_prd  
0    2024.09  
1    2024.09  
2    2024.09  
3    2024.09  
4    2024.09  
..       ...  
158  2025.04  
159  2025.04  
160  2025.04  
161  2025.04  
162  2025.04  

[163 rows x 9 columns], 'PG':       timestamp    open    high     low   close    volume      wap  barCount  \
0    2024-09-03  171.03  175.00  170.99  174.52   4644091  173.819     23517   
1    2024-09-04  173.63  176.00  173.63  175.90   3362278  175.205     15348   
2    2024-09-05  175.99  176.55  174.67  175.47   2638945  175.572     15213   
3    2024-09-06  175.76  177.04  175.34  175.59   2634944  176.108     15730   
4    2024-09-09  175.54  176.84  174.66  176.06   2613870  175.874     14767   
..          ...     ...     ...     ...     ...       ...      ...       ...   
158  2025-04-22  165.86  168.77  164.53  167.88   3581981  167.265     21725   
159  2025-04-23  166.40  166.61  163.11  165.73   4673274  164.881     29335   
160  2025-04-24  160.50  160.96  156.58  159.53  11734049  158.760     72422   
161  2025-04-25  159.88  161.80  157.77  161.02   7659314  159.865     42108   
162  2025-04-28  161.04  162.56  160.39  161.85   3986691  161.509     24935   

     trd_prd  
0    2024.09  
1    2024.09  
2    2024.09  
3    2024.09  
4    2024.09  
..       ...  
158  2025.04  
159  2025.04  
160  2025.04  
161  2025.04  
162  2025.04  

[163 rows x 9 columns], 'NVDA':       timestamp    open    high     low   close     volume      wap  barCount  \
0    2024-09-03  116.01  116.21  107.29  108.00  353878209  110.529   1029657   
1    2024-09-04  105.40  109.99  104.12  106.21  300265583  107.433    863910   
2    2024-09-05  104.97  109.65  104.76  107.21  236896049  107.518    649450   
3    2024-09-06  108.06  108.15  100.95  102.83  307106247  103.297    889372   
4    2024-09-09  104.86  106.55  103.69  106.47  207564871  105.334    557331   
..          ...     ...     ...     ...     ...        ...      ...       ...   
158  2025-04-22   98.76   99.82   97.28   98.89  173367412   98.654    625207   
159  2025-04-23  104.52  104.80  102.02  102.71  174026787  103.545    651877   
160  2025-04-24  103.49  106.54  103.11  106.43  153070523  105.440    527622   
161  2025-04-25  106.86  111.92  105.73  111.01  191454295  109.484    658331   
162  2025-04-28  109.70  110.37  106.02  108.73  151048496  107.873    504581   

     trd_prd  
0    2024.09  
1    2024.09  
2    2024.09  
3    2024.09  
4    2024.09  
..       ...  
158  2025.04  
159  2025.04  
160  2025.04  
161  2025.04  
162  2025.04  

[163 rows x 9 columns], 'CAT':       timestamp    open    high     low   close   volume      wap  barCount  \
0    2024-09-03  352.21  352.63  338.40  340.24  1561491  341.648     10302   
1    2024-09-04  338.59  340.85  335.29  336.75   785571  337.586      5261   
2    2024-09-05  336.02  336.49  330.56  333.56  1197110  333.299      7883   
3    2024-09-06  334.20  338.62  328.12  329.36  1144155  330.603      8008   
4    2024-09-09  333.91  336.36  332.97  334.04  1055039  334.632      7096   
..          ...     ...     ...     ...     ...      ...      ...       ...   
158  2025-04-22  287.50  293.24  287.00  291.17  1088446  290.353      7204   
159  2025-04-23  301.34  305.36  295.18  295.77  1100232  299.638      7935   
160  2025-04-24  297.43  308.21  297.07  306.86  1284464  305.698      9481   
161  2025-04-25  305.10  307.99  303.91  306.45  1091024  305.985      7580   
162  2025-04-28  306.45  311.43  303.85  307.06   982793  307.174      6946   

     trd_prd  
0    2024.09  
1    2024.09  
2    2024.09  
3    2024.09  
4    2024.09  
..       ...  
158  2025.04  
159  2025.04  
160  2025.04  
161  2025.04  
162  2025.04  

[163 rows x 9 columns], 'HD':       timestamp    open    high     low   close   volume      wap  barCount  \
0    2024-09-03  367.90  369.38  362.90  364.74   929997  365.947      6612   
1    2024-09-04  364.17  365.93  360.01  364.67  1340658  363.514      7782   
2    2024-09-05  364.90  365.15  357.58  361.85  1098417  360.605      8141   
3    2024-09-06  362.92  365.44  359.42  360.05   869802  361.684      6272   
4    2024-09-09  362.76  366.16  360.03  365.52   949434  364.140      6436   
..          ...     ...     ...     ...     ...      ...      ...       ...   
158  2025-04-22  351.16  356.22  350.42  354.43  1241447  353.428      8613   
159  2025-04-23  361.92  364.84  354.85  356.42  1327973  358.914      9348   
160  2025-04-24  356.50  360.40  354.61  359.64   914824  358.552      6621   
161  2025-04-25  357.70  359.00  354.74  357.58   908330  356.638      5968   
162  2025-04-28  357.99  360.10  354.51  356.92   849381  357.094      5851   

     trd_prd  
0    2024.09  
1    2024.09  
2    2024.09  
3    2024.09  
4    2024.09  
..       ...  
158  2025.04  
159  2025.04  
160  2025.04  
161  2025.04  
162  2025.04  

[163 rows x 9 columns], 'AMZN':       timestamp    open    high     low   close    volume      wap  barCount  \
0    2024-09-03  177.55  178.26  175.26  176.25  23449672  176.514    109837   
1    2024-09-04  174.44  175.98  172.54  173.33  18780456  174.038     89203   
2    2024-09-05  175.03  179.88  174.99  177.89  26927218  177.648    129174   
3    2024-09-06  177.28  178.38  171.16  171.39  21536348  173.289    110416   
4    2024-09-09  174.53  175.85  173.51  175.40  16695426  174.655     73172   
..          ...     ...     ...     ...     ...       ...      ...       ...   
158  2025-04-22  169.93  176.78  169.35  173.18  35128801  173.149    165383   
159  2025-04-23  183.45  187.38  180.19  180.60  40420487  183.659    193047   
160  2025-04-24  180.76  186.74  180.18  186.54  24600422  184.347    128798   
161  2025-04-25  187.62  189.94  185.49  188.99  22186683  187.825    112985   
162  2025-04-28  190.11  190.22  184.88  187.70  19078488  187.392    101997   

     trd_prd  
0    2024.09  
1    2024.09  
2    2024.09  
3    2024.09  
4    2024.09  
..       ...  
158  2025.04  
159  2025.04  
160  2025.04  
161  2025.04  
162  2025.04  

[163 rows x 9 columns]}
{'AAPL':                timestamp    open    high     low   close   volume      wap  \
0    2024-09-03 09:30:00  228.55  229.00  225.30  226.16  5159511  226.992   
1    2024-09-03 10:00:00  226.19  226.48  223.51  223.65  4867498  224.802   
2    2024-09-03 11:00:00  223.65  224.67  223.27  223.54  3094347  224.041   
3    2024-09-03 12:00:00  223.55  224.32  223.34  223.71  2245287  223.806   
4    2024-09-03 13:00:00  223.72  224.15  223.18  223.21  1967720  223.666   
...                  ...     ...     ...     ...     ...      ...      ...   
1130 2025-04-28 11:00:00  209.03  209.53  207.58  207.96  2474776  208.395   
1131 2025-04-28 12:00:00  207.95  208.73  207.46  208.45  1690650  208.042   
1132 2025-04-28 13:00:00  208.43  209.86  207.91  209.75  1836726  208.806   
1133 2025-04-28 14:00:00  209.73  210.10  209.46  209.84  1887764  209.857   
1134 2025-04-28 15:00:00  209.87  211.50  209.80  210.09  3858763  210.587   

      barCount  trd_prd  
0        22740  2024.09  
1        27873  2024.09  
2        18076  2024.09  
3        13506  2024.09  
4        11376  2024.09  
...        ...      ...  
1130     14224  2025.04  
1131      9032  2025.04  
1132     10470  2025.04  
1133     10694  2025.04  
1134     20058  2025.04  

[1135 rows x 9 columns], 'MSFT':                timestamp    open    high     low   close   volume      wap  \
0    2024-09-03 09:30:00  417.95  419.88  415.34  418.21  1424921  417.812   
1    2024-09-03 10:00:00  418.15  418.50  413.05  413.40  1447443  415.936   
2    2024-09-03 11:00:00  413.50  414.11  411.51  411.60   858323  413.137   
3    2024-09-03 12:00:00  411.63  413.21  410.88  411.21   679437  411.793   
4    2024-09-03 13:00:00  411.22  412.03  410.85  410.97   515289  411.314   
...                  ...     ...     ...     ...     ...      ...      ...   
1130 2025-04-28 11:00:00  390.46  390.71  387.50  387.91   655265  388.773   
1131 2025-04-28 12:00:00  387.91  388.28  386.70  387.49   524840  387.588   
1132 2025-04-28 13:00:00  387.44  389.42  386.63  389.32   575576  387.790   
1133 2025-04-28 14:00:00  389.34  391.10  389.16  390.83   976057  390.299   
1134 2025-04-28 15:00:00  390.87  392.74  390.72  391.16  1703965  391.590   

      barCount  trd_prd  
0         5964  2024.09  
1         8586  2024.09  
2         5007  2024.09  
3         3962  2024.09  
4         3150  2024.09  
...        ...      ...  
1130      4257  2025.04  
1131      3395  2025.04  
1132      4001  2025.04  
1133      6346  2025.04  
1134     11763  2025.04  

[1135 rows x 9 columns], 'JPM':                timestamp    open    high     low   close  volume      wap  \
0    2024-09-03 09:30:00  222.30  224.10  222.02  223.02  728800  222.879   
1    2024-09-03 10:00:00  222.97  223.20  220.42  221.73  795413  221.254   
2    2024-09-03 11:00:00  221.73  222.98  221.50  222.78  614272  222.371   
3    2024-09-03 12:00:00  222.80  223.32  222.09  222.14  443699  222.566   
4    2024-09-03 13:00:00  222.15  222.64  221.54  221.59  366021  221.989   
...                  ...     ...     ...     ...     ...     ...      ...   
1130 2025-04-28 11:00:00  242.91  243.37  241.29  241.84  536620  242.208   
1131 2025-04-28 12:00:00  241.84  241.88  240.92  241.26  409715  241.354   
1132 2025-04-28 13:00:00  241.26  241.87  240.84  241.82  292164  241.286   
1133 2025-04-28 14:00:00  241.79  242.11  241.07  241.94  302916  241.686   
1134 2025-04-28 15:00:00  241.99  243.50  241.93  243.14  852023  242.919   

      barCount  trd_prd  
0         3132  2024.09  
1         4938  2024.09  
2         3340  2024.09  
3         2886  2024.09  
4         2359  2024.09  
...        ...      ...  
1130      3471  2025.04  
1131      2443  2025.04  
1132      1815  2025.04  
1133      2001  2025.04  
1134      5623  2025.04  

[1135 rows x 9 columns], 'XOM':                timestamp    open    high     low   close   volume      wap  \
0    2024-09-03 09:30:00  115.84  115.97  114.62  114.70  1260424  115.223   
1    2024-09-03 10:00:00  114.70  114.89  114.04  114.75  1442767  114.397   
2    2024-09-03 11:00:00  114.74  115.36  114.46  115.12  1265923  114.931   
3    2024-09-03 12:00:00  115.12  115.77  115.12  115.56   763750  115.571   
4    2024-09-03 13:00:00  115.55  115.99  115.51  115.79   650146  115.759   
...                  ...     ...     ...     ...     ...      ...      ...   
1130 2025-04-28 11:00:00  108.59  108.73  107.97  108.03   655366  108.283   
1131 2025-04-28 12:00:00  108.03  108.36  107.91  108.01   557112  108.147   
1132 2025-04-28 13:00:00  108.02  108.18  107.68  108.15   564008  107.876   
1133 2025-04-28 14:00:00  108.15  108.54  108.09  108.39   574365  108.321   
1134 2025-04-28 15:00:00  108.40  109.01  108.39  108.67  1270169  108.698   

      barCount  trd_prd  
0         5265  2024.09  
1         7984  2024.09  
2         6535  2024.09  
3         4202  2024.09  
4         3757  2024.09  
...        ...      ...  
1130      4166  2025.04  
1131      3457  2025.04  
1132      3345  2025.04  
1133      3759  2025.04  
1134      7572  2025.04  

[1135 rows x 9 columns], 'JNJ':                timestamp    open    high     low   close  volume      wap  \
0    2024-09-03 09:30:00  165.24  166.80  164.77  166.53  507902  165.921   
1    2024-09-03 10:00:00  166.60  167.48  166.26  167.43  536715  166.875   
2    2024-09-03 11:00:00  167.43  167.58  166.32  167.10  359542  166.879   
3    2024-09-03 12:00:00  167.10  167.67  166.94  167.12  302752  167.329   
4    2024-09-03 13:00:00  167.16  167.48  167.00  167.33  253748  167.285   
...                  ...     ...     ...     ...     ...     ...      ...   
1130 2025-04-28 11:00:00  155.25  155.39  155.03  155.10  259417  155.213   
1131 2025-04-28 12:00:00  155.12  155.28  154.80  154.95  235528  155.084   
1132 2025-04-28 13:00:00  154.96  155.20  154.65  154.94  277290  154.922   
1133 2025-04-28 14:00:00  154.94  155.23  154.88  154.97  280731  155.060   
1134 2025-04-28 15:00:00  154.99  155.78  154.97  155.32  940123  155.366   

      barCount  trd_prd  
0         1586  2024.09  
1         2952  2024.09  
2         2204  2024.09  
3         1754  2024.09  
4         1517  2024.09  
...        ...      ...  
1130      1715  2025.04  
1131      1510  2025.04  
1132      1751  2025.04  
1133      1951  2025.04  
1134      5602  2025.04  

[1135 rows x 9 columns], 'PG':                timestamp    open    high     low   close   volume      wap  \
0    2024-09-03 09:30:00  171.03  173.33  170.99  173.33  1233919  172.066   
1    2024-09-03 10:00:00  173.37  174.85  173.19  174.82   706059  173.995   
2    2024-09-03 11:00:00  174.80  175.00  173.83  174.30   789304  174.681   
3    2024-09-03 12:00:00  174.29  174.89  174.04  174.49   306583  174.439   
4    2024-09-03 13:00:00  174.49  174.95  174.44  174.91   249363  174.699   
...                  ...     ...     ...     ...     ...      ...      ...   
1130 2025-04-28 11:00:00  161.66  162.56  161.44  161.75   735097  161.932   
1131 2025-04-28 12:00:00  161.74  161.91  161.03  161.18   458252  161.574   
1132 2025-04-28 13:00:00  161.18  161.29  160.80  161.25   318072  161.073   
1133 2025-04-28 14:00:00  161.25  161.52  161.09  161.17   349362  161.258   
1134 2025-04-28 15:00:00  161.16  162.23  161.14  161.87   940131  161.932   

      barCount  trd_prd  
0         3285  2024.09  
1         3622  2024.09  
2         3910  2024.09  
3         1938  2024.09  
4         1776  2024.09  
...        ...      ...  
1130      4086  2025.04  
1131      2498  2025.04  
1132      2164  2025.04  
1133      2422  2025.04  
1134      6678  2025.04  

[1135 rows x 9 columns], 'NVDA':                timestamp    open    high     low   close    volume      wap  \
0    2024-09-03 09:30:00  116.01  116.21  112.01  112.91  55565367  113.563   
1    2024-09-03 10:00:00  112.93  113.53  109.61  109.77  78685232  111.406   
2    2024-09-03 11:00:00  109.77  111.68  109.39  110.36  47581597  110.831   
3    2024-09-03 12:00:00  110.35  110.84  109.80  110.17  33882214  110.313   
4    2024-09-03 13:00:00  110.18  110.73  109.57  109.59  26067140  110.177   
...                  ...     ...     ...     ...     ...       ...      ...   
1130 2025-04-28 11:00:00  107.80  108.00  106.38  107.28  25317057  107.176   
1131 2025-04-28 12:00:00  107.27  107.34  106.52  106.70  14626693  106.878   
1132 2025-04-28 13:00:00  106.69  107.04  106.02  106.99  15086612  106.499   
1133 2025-04-28 14:00:00  106.99  107.60  106.70  107.47  12975188  107.215   
1134 2025-04-28 15:00:00  107.47  108.85  107.41  108.64  24448071  108.348   

      barCount  trd_prd  
0       155058  2024.09  
1       225773  2024.09  
2       130388  2024.09  
3        93029  2024.09  
4        73159  2024.09  
...        ...      ...  
1130     85008  2025.04  
1131     50120  2025.04  
1132     50571  2025.04  
1133     45348  2025.04  
1134     87517  2025.04  

[1135 rows x 9 columns], 'CAT':                timestamp    open    high     low   close  volume      wap  \
0    2024-09-03 09:30:00  352.21  352.63  344.64  345.93  269621  347.946   
1    2024-09-03 10:00:00  345.49  345.89  338.97  340.12  388757  340.563   
2    2024-09-03 11:00:00  340.20  342.23  340.02  341.45  101078  341.505   
3    2024-09-03 12:00:00  341.47  341.97  340.32  340.57  144511  341.010   
4    2024-09-03 13:00:00  340.57  341.32  339.88  340.29  124432  340.680   
...                  ...     ...     ...     ...     ...     ...      ...   
1130 2025-04-28 11:00:00  309.53  309.80  306.15  306.57  123947  307.485   
1131 2025-04-28 12:00:00  306.63  306.63  304.25  305.06  143884  305.295   
1132 2025-04-28 13:00:00  305.13  305.49  303.85  305.39  102687  304.687   
1133 2025-04-28 14:00:00  305.32  306.44  305.04  305.98  103291  305.727   
1134 2025-04-28 15:00:00  305.98  308.00  305.97  306.91  258717  307.042   

      barCount  trd_prd  
0         1298  2024.09  
1         2309  2024.09  
2          816  2024.09  
3         1086  2024.09  
4          826  2024.09  
...        ...      ...  
1130       883  2025.04  
1131      1046  2025.04  
1132       641  2025.04  
1133       756  2025.04  
1134      1976  2025.04  

[1135 rows x 9 columns], 'HD':                timestamp    open    high     low   close  volume      wap  \
0    2024-09-03 09:30:00  367.90  369.38  366.27  368.37  165031  368.111   
1    2024-09-03 10:00:00  368.31  368.32  365.50  367.21  111703  366.627   
2    2024-09-03 11:00:00  367.18  368.62  366.82  367.15  109320  367.601   
3    2024-09-03 12:00:00  367.00  367.37  364.58  364.84   92013  365.837   
4    2024-09-03 13:00:00  364.87  366.31  364.58  365.51   68224  365.594   
...                  ...     ...     ...     ...     ...     ...      ...   
1130 2025-04-28 11:00:00  358.48  358.72  356.44  356.70   60164  357.571   
1131 2025-04-28 12:00:00  356.76  356.81  355.19  355.44   84138  355.890   
1132 2025-04-28 13:00:00  355.50  356.07  354.51  355.83   72638  355.246   
1133 2025-04-28 14:00:00  355.86  356.19  354.83  356.10  122718  355.594   
1134 2025-04-28 15:00:00  356.16  358.05  356.09  356.85  269779  357.045   

      barCount  trd_prd  
0          826  2024.09  
1          830  2024.09  
2          760  2024.09  
3          752  2024.09  
4          558  2024.09  
...        ...      ...  
1130       474  2025.04  
1131       531  2025.04  
1132       479  2025.04  
1133       798  2025.04  
1134      2098  2025.04  

[1135 rows x 9 columns], 'AMZN':                timestamp    open    high     low   close   volume      wap  \
0    2024-09-03 09:30:00  177.55  178.26  176.17  177.69  4431652  177.340   
1    2024-09-03 10:00:00  177.67  177.69  175.56  175.98  4589648  176.547   
2    2024-09-03 11:00:00  176.02  176.93  175.26  175.52  2549826  176.267   
3    2024-09-03 12:00:00  175.52  176.41  175.45  176.27  2109854  175.957   
4    2024-09-03 13:00:00  176.27  176.88  176.17  176.20  2037978  176.456   
...                  ...     ...     ...     ...     ...      ...      ...   
1130 2025-04-28 11:00:00  188.14  188.48  185.66  186.07  3267698  186.680   
1131 2025-04-28 12:00:00  186.02  186.10  184.88  185.60  2212854  185.559   
1132 2025-04-28 13:00:00  185.60  186.15  185.00  186.06  1455203  185.497   
1133 2025-04-28 14:00:00  186.06  186.64  185.63  186.56  1583968  186.171   
1134 2025-04-28 15:00:00  186.57  188.48  186.48  187.67  3483161  187.603   

      barCount  trd_prd  
0        15598  2024.09  
1        21850  2024.09  
2        11884  2024.09  
3        10689  2024.09  
4        10220  2024.09  
...        ...      ...  
1130     18549  2025.04  
1131     12941  2025.04  
1132      7999  2025.04  
1133      8331  2025.04  
1134     19136  2025.04  

[1135 rows x 9 columns]}
{'AAPL':       timestamp      open      high       low     close  volume    wap  \
0    2024-07-03  0.243975  0.248357  0.241547  0.248357       1  0.248   
1    2024-07-05  0.247372  0.255151  0.247372  0.252611       1  0.255   
2    2024-07-08  0.251865  0.261834  0.251865  0.253897       1  0.262   
3    2024-07-09  0.253373  0.258707  0.250643  0.250658       1  0.259   
4    2024-07-10  0.251468  0.257961  0.250912  0.257199       1  0.258   
..          ...       ...       ...       ...       ...     ...    ...   
200  2025-04-22  0.439311  0.439311  0.398704  0.409896       1  0.439   
201  2025-04-23  0.406753  0.406753  0.362621  0.390561       1  0.407   
202  2025-04-24  0.385544  0.385544  0.359129  0.362018       1  0.386   
203  2025-04-25  0.359637  0.361558  0.331587  0.339905       1  0.362   
204  2025-04-28  0.333396  0.352763  0.330333  0.336222       1  0.353   

     barCount  trd_prd  
0           0  2024.07  
1           0  2024.07  
2           0  2024.07  
3           0  2024.07  
4           0  2024.07  
..        ...      ...  
200         0  2025.04  
201         0  2025.04  
202         0  2025.04  
203         0  2025.04  
204         0  2025.04  

[205 rows x 9 columns], 'MSFT':       timestamp      open      high       low     close  volume    wap  \
0    2024-07-03  0.239292  0.242721  0.236594  0.237276       1  0.243   
1    2024-07-05  0.238657  0.248071  0.238657  0.247118       1  0.248   
2    2024-07-08  0.244531  0.254119  0.244531  0.248928       1  0.254   
3    2024-07-09  0.249071  0.252786  0.247007  0.252087       1  0.253   
4    2024-07-10  0.252230  0.255246  0.249246  0.254389       1  0.255   
..          ...       ...       ...       ...       ...     ...    ...   
200  2025-04-22  0.372162  0.372162  0.342858  0.353287       1  0.372   
201  2025-04-23  0.348874  0.348874  0.313379  0.339651       1  0.349   
202  2025-04-24  0.338397  0.338397  0.318681  0.321237       1  0.338   
203  2025-04-25  0.319141  0.319141  0.301838  0.304251       1  0.319   
204  2025-04-28  0.296822  0.320125  0.296822  0.310617       1  0.320   

     barCount  trd_prd  
0           0  2024.07  
1           0  2024.07  
2           0  2024.07  
3           0  2024.07  
4           0  2024.07  
..        ...      ...  
200         0  2025.04  
201         0  2025.04  
202         0  2025.04  
203         0  2025.04  
204         0  2025.04  

[205 rows x 9 columns], 'JPM':       timestamp      open      high       low     close  volume    wap  \
0    2024-07-03  0.211528  0.211528  0.203210  0.207305       1  0.212   
1    2024-07-05  0.204591  0.211861  0.204591  0.210067       1  0.212   
2    2024-07-08  0.206178  0.215941  0.206178  0.209099       1  0.216   
3    2024-07-09  0.209337  0.214750  0.205861  0.210210       1  0.215   
4    2024-07-10  0.210845  0.213099  0.206115  0.212957       1  0.213   
..          ...       ...       ...       ...       ...     ...    ...   
200  2025-04-22  0.348684  0.348684  0.308029  0.316284       1  0.349   
201  2025-04-23  0.313014  0.314664  0.278931  0.308966       1  0.315   
202  2025-04-24  0.305235  0.305235  0.276312  0.277423       1  0.305   
203  2025-04-25  0.279106  0.282947  0.265612  0.267708       1  0.283   
204  2025-04-28  0.262961  0.278836  0.262088  0.263136       1  0.279   

     barCount  trd_prd  
0           0  2024.07  
1           0  2024.07  
2           0  2024.07  
3           0  2024.07  
4           0  2024.07  
..        ...      ...  
200         0  2025.04  
201         0  2025.04  
202         0  2025.04  
203         0  2025.04  
204         0  2025.04  

[205 rows x 9 columns], 'XOM':       timestamp      open      high       low     close  volume    wap  \
0    2024-07-03  0.201955  0.203829  0.190510  0.198495       1  0.204   
1    2024-07-05  0.200098  0.206242  0.200003  0.202511       1  0.206   
2    2024-07-08  0.203511  0.211956  0.200908  0.208766       1  0.212   
3    2024-07-09  0.207559  0.211718  0.206765  0.208972       1  0.212   
4    2024-07-10  0.209417  0.216671  0.203019  0.209051       1  0.217   
..          ...       ...       ...       ...       ...     ...    ...   
200  2025-04-22  0.349715  0.351573  0.308743  0.324665       1  0.352   
201  2025-04-23  0.322919  0.334365  0.301663  0.327713       1  0.334   
202  2025-04-24  0.324491  0.324491  0.296060  0.296568       1  0.324   
203  2025-04-25  0.295694  0.303219  0.281646  0.281646       1  0.303   
204  2025-04-28  0.274867  0.291900  0.271645  0.279471       1  0.292   

     barCount  trd_prd  
0           0  2024.07  
1           0  2024.07  
2           0  2024.07  
3           0  2024.07  
4           0  2024.07  
..        ...      ...  
200         0  2025.04  
201         0  2025.04  
202         0  2025.04  
203         0  2025.04  
204         0  2025.04  

[205 rows x 9 columns], 'JNJ':       timestamp      open      high       low     close  volume    wap  \
0    2024-07-03  0.171365  0.184605  0.168508  0.178302       1  0.185   
1    2024-07-05  0.165841  0.177445  0.165841  0.170968       1  0.177   
2    2024-07-08  0.169762  0.180049  0.169762  0.178874       1  0.180   
3    2024-07-09  0.180747  0.184954  0.178842  0.182319       1  0.185   
4    2024-07-10  0.177382  0.189272  0.177382  0.185446       1  0.189   
..          ...       ...       ...       ...       ...     ...    ...   
200  2025-04-22  0.207670  0.208591  0.183859  0.199527       1  0.209   
201  2025-04-23  0.201495  0.206067  0.184970  0.202940       1  0.206   
202  2025-04-24  0.200924  0.205003  0.193494  0.194526       1  0.205   
203  2025-04-25  0.197320  0.209988  0.186160  0.201479       1  0.210   
204  2025-04-28  0.197066  0.202067  0.189748  0.190272       1  0.202   

     barCount  trd_prd  
0           0  2024.07  
1           0  2024.07  
2           0  2024.07  
3           0  2024.07  
4           0  2024.07  
..        ...      ...  
200         0  2025.04  
201         0  2025.04  
202         0  2025.04  
203         0  2025.04  
204         0  2025.04  

[205 rows x 9 columns], 'PG':       timestamp      open      high       low     close  volume    wap  \
0    2024-07-03  0.151300  0.185700  0.149474  0.156618       1  0.186   
1    2024-07-05  0.154110  0.162698  0.150887  0.159634       1  0.163   
2    2024-07-08  0.157396  0.169667  0.157396  0.166746       1  0.170   
3    2024-07-09  0.167524  0.169825  0.162793  0.169825       1  0.170   
4    2024-07-10  0.171842  0.171842  0.160856  0.168968       1  0.172   
..          ...       ...       ...       ...       ...     ...    ...   
200  2025-04-22  0.284185  0.284185  0.248690  0.258866       1  0.284   
201  2025-04-23  0.260548  0.278629  0.253865  0.261517       1  0.279   
202  2025-04-24  0.260421  0.260421  0.197463  0.208782       1  0.260   
203  2025-04-25  0.218528  0.218528  0.184652  0.187653       1  0.219   
204  2025-04-28  0.188224  0.204353  0.188224  0.194812       1  0.204   

     barCount  trd_prd  
0           0  2024.07  
1           0  2024.07  
2           0  2024.07  
3           0  2024.07  
4           0  2024.07  
..        ...      ...  
200         0  2025.04  
201         0  2025.04  
202         0  2025.04  
203         0  2025.04  
204         0  2025.04  

[205 rows x 9 columns], 'NVDA':       timestamp      open      high       low     close  volume    wap  \
0    2024-07-03  0.450376  0.461758  0.448248  0.456376       1  0.462   
1    2024-07-05  0.459615  0.481442  0.459615  0.464186       1  0.481   
2    2024-07-08  0.468917  0.490856  0.468917  0.475045       1  0.491   
3    2024-07-09  0.473537  0.481156  0.472219  0.472330       1  0.481   
4    2024-07-10  0.471425  0.479077  0.462313  0.467187       1  0.479   
..          ...       ...       ...       ...       ...     ...    ...   
200  2025-04-22  0.575022  0.575022  0.528192  0.547115       1  0.575   
201  2025-04-23  0.540210  0.540210  0.482236  0.507905       1  0.540   
202  2025-04-24  0.500793  0.500793  0.477172  0.477172       1  0.501   
203  2025-04-25  0.484776  0.489903  0.465964  0.476553       1  0.490   
204  2025-04-28  0.496507  0.546194  0.496507  0.529701       1  0.546   

     barCount  trd_prd  
0           0  2024.07  
1           0  2024.07  
2           0  2024.07  
3           0  2024.07  
4           0  2024.07  
..        ...      ...  
200         0  2025.04  
201         0  2025.04  
202         0  2025.04  
203         0  2025.04  
204         0  2025.04  

[205 rows x 9 columns], 'CAT':       timestamp      open      high       low     close  volume    wap  \
0    2024-07-03  0.218624  0.221418  0.211941  0.213861       1  0.221   
1    2024-07-05  0.229164  0.239308  0.229164  0.232958       1  0.239   
2    2024-07-08  0.252976  0.264326  0.252976  0.263866       1  0.264   
3    2024-07-09  0.268597  0.277836  0.266025  0.277217       1  0.278   
4    2024-07-10  0.280455  0.291519  0.280455  0.290615       1  0.292   
..          ...       ...       ...       ...       ...     ...    ...   
200  2025-04-22  0.417912  0.417912  0.381560  0.390100       1  0.418   
201  2025-04-23  0.385322  0.385322  0.351081  0.373289       1  0.385   
202  2025-04-24  0.366542  0.366542  0.350954  0.352906       1  0.367   
203  2025-04-25  0.351366  0.359812  0.345874  0.352668       1  0.360   
204  2025-04-28  0.345286  0.371225  0.345286  0.358478       1  0.371   

     barCount  trd_prd  
0           0  2024.07  
1           0  2024.07  
2           0  2024.07  
3           0  2024.07  
4           0  2024.07  
..        ...      ...  
200         0  2025.04  
201         0  2025.04  
202         0  2025.04  
203         0  2025.04  
204         0  2025.04  

[205 rows x 9 columns], 'HD':       timestamp      open      high       low     close  volume    wap  \
0    2024-07-03  0.197050  0.197050  0.191399  0.194971       1  0.197   
1    2024-07-05  0.195510  0.202352  0.195510  0.200320       1  0.202   
2    2024-07-08  0.201479  0.207972  0.201479  0.204892       1  0.208   
3    2024-07-09  0.204194  0.210639  0.203067  0.208480       1  0.211   
4    2024-07-10  0.207353  0.214782  0.202844  0.213607       1  0.215   
..          ...       ...       ...       ...       ...     ...    ...   
200  2025-04-22  0.357589  0.357589  0.322221  0.331888       1  0.358   
201  2025-04-23  0.332809  0.336063  0.303013  0.332190       1  0.336   
202  2025-04-24  0.326078  0.331666  0.307696  0.309870       1  0.332   
203  2025-04-25  0.307188  0.315236  0.300314  0.303870       1  0.315   
204  2025-04-28  0.295599  0.308966  0.286487  0.296790       1  0.309   

     barCount  trd_prd  
0           0  2024.07  
1           0  2024.07  
2           0  2024.07  
3           0  2024.07  
4           0  2024.07  
..        ...      ...  
200         0  2025.04  
201         0  2025.04  
202         0  2025.04  
203         0  2025.04  
204         0  2025.04  

[205 rows x 9 columns], 'AMZN':       timestamp      open      high       low     close  volume    wap  \
0    2024-07-03  0.383449  0.387846  0.379988  0.382750       1  0.388   
1    2024-07-05  0.383084  0.390497  0.371479  0.372257       1  0.390   
2    2024-07-08  0.368035  0.391354  0.368035  0.382607       1  0.391   
3    2024-07-09  0.383274  0.385290  0.376686  0.377321       1  0.385   
4    2024-07-10  0.378385  0.386782  0.378385  0.382988       1  0.387   
..          ...       ...       ...       ...       ...     ...    ...   
200  2025-04-22  0.490332  0.490332  0.452693  0.463345       1  0.490   
201  2025-04-23  0.462440  0.462440  0.425103  0.454392       1  0.462   
202  2025-04-24  0.451519  0.452090  0.427437  0.431929       1  0.452   
203  2025-04-25  0.431580  0.431580  0.406514  0.408562       1  0.432   
204  2025-04-28  0.402165  0.429024  0.402165  0.414595       1  0.429   

     barCount  trd_prd  
0           0  2024.07  
1           0  2024.07  
2           0  2024.07  
3           0  2024.07  
4           0  2024.07  
..        ...      ...  
200         0  2025.04  
201         0  2025.04  
202         0  2025.04  
203         0  2025.04  
204         0  2025.04  

[205 rows x 9 columns]}</code></pre>
</div>
</div>
<section id="yr-yield-spread" class="level1">
<h1>10-2Yr Yield Spread</h1>
<div id="initial_id" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-28T23:30:33.638020Z&quot;,&quot;start_time&quot;:&quot;2025-04-28T23:30:12.517906Z&quot;}" data-execution_count="12">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>YYYY <span class="op">=</span> [<span class="dv">2024</span>, <span class="dv">2025</span>]</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>URL_lst <span class="op">=</span> [<span class="st">'https://home.treasury.gov/resource-center/data-chart-center/interest-rates/TextView?type='</span> <span class="op">+</span> <span class="st">'daily_treasury_yield_curve&amp;field_tdr_date_value='</span> <span class="op">+</span> <span class="bu">str</span>(year) <span class="cf">for</span> year <span class="kw">in</span> YYYY]</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>df_yield_curve <span class="op">=</span> pd.DataFrame()</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> URL <span class="kw">in</span> URL_lst:</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>    cmt_rates_page <span class="op">=</span> requests.get(URL)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    soup <span class="op">=</span> BeautifulSoup(cmt_rates_page.content, <span class="st">'html.parser'</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    table_html <span class="op">=</span> soup.findAll(<span class="st">'table'</span>, {<span class="st">'class'</span>: <span class="st">'views-table'</span>})</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> pd.read_html(io.StringIO(<span class="bu">str</span>(table_html)))[<span class="dv">0</span>]</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>    df.Date <span class="op">=</span> pd.to_datetime(df.Date)</span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># usdt_3mo_cmt = df.rename(columns={'3 Mo': '3_mo'})</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>    df_yield_curve <span class="op">=</span> pd.concat([df_yield_curve, df])</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>df_yield_curve <span class="op">=</span> df_yield_curve[[<span class="st">'Date'</span>, <span class="st">'2 Mo'</span>, <span class="st">'3 Mo'</span>, <span class="st">'4 Mo'</span>, <span class="st">'6 Mo'</span>, <span class="st">'1 Yr'</span>, <span class="st">'2 Yr'</span>, <span class="st">'3 Yr'</span>, <span class="st">'5 Yr'</span>, <span class="st">'7 Yr'</span>, <span class="st">'10 Yr'</span>, <span class="st">'20 Yr'</span>, <span class="st">'30 Yr'</span>]]</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>df_yield_curve</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th">2 Mo</th>
<th data-quarto-table-cell-role="th">3 Mo</th>
<th data-quarto-table-cell-role="th">4 Mo</th>
<th data-quarto-table-cell-role="th">6 Mo</th>
<th data-quarto-table-cell-role="th">1 Yr</th>
<th data-quarto-table-cell-role="th">2 Yr</th>
<th data-quarto-table-cell-role="th">3 Yr</th>
<th data-quarto-table-cell-role="th">5 Yr</th>
<th data-quarto-table-cell-role="th">7 Yr</th>
<th data-quarto-table-cell-role="th">10 Yr</th>
<th data-quarto-table-cell-role="th">20 Yr</th>
<th data-quarto-table-cell-role="th">30 Yr</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2024-01-02</td>
<td>5.54</td>
<td>5.46</td>
<td>5.41</td>
<td>5.24</td>
<td>4.80</td>
<td>4.33</td>
<td>4.09</td>
<td>3.93</td>
<td>3.95</td>
<td>3.95</td>
<td>4.25</td>
<td>4.08</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2024-01-03</td>
<td>5.54</td>
<td>5.48</td>
<td>5.41</td>
<td>5.25</td>
<td>4.81</td>
<td>4.33</td>
<td>4.07</td>
<td>3.90</td>
<td>3.92</td>
<td>3.91</td>
<td>4.21</td>
<td>4.05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2024-01-04</td>
<td>5.48</td>
<td>5.48</td>
<td>5.41</td>
<td>5.25</td>
<td>4.85</td>
<td>4.38</td>
<td>4.14</td>
<td>3.97</td>
<td>3.99</td>
<td>3.99</td>
<td>4.30</td>
<td>4.13</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2024-01-05</td>
<td>5.48</td>
<td>5.47</td>
<td>5.41</td>
<td>5.24</td>
<td>4.84</td>
<td>4.40</td>
<td>4.17</td>
<td>4.02</td>
<td>4.04</td>
<td>4.05</td>
<td>4.37</td>
<td>4.21</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2024-01-08</td>
<td>5.48</td>
<td>5.49</td>
<td>5.39</td>
<td>5.24</td>
<td>4.82</td>
<td>4.36</td>
<td>4.11</td>
<td>3.97</td>
<td>3.99</td>
<td>4.01</td>
<td>4.33</td>
<td>4.17</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75</td>
<td>2025-04-22</td>
<td>4.35</td>
<td>4.33</td>
<td>4.33</td>
<td>4.21</td>
<td>3.98</td>
<td>3.76</td>
<td>3.82</td>
<td>3.98</td>
<td>4.19</td>
<td>4.41</td>
<td>4.90</td>
<td>4.88</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">76</td>
<td>2025-04-23</td>
<td>4.34</td>
<td>4.33</td>
<td>4.33</td>
<td>4.22</td>
<td>4.01</td>
<td>3.81</td>
<td>3.87</td>
<td>4.00</td>
<td>4.20</td>
<td>4.40</td>
<td>4.86</td>
<td>4.83</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">77</td>
<td>2025-04-24</td>
<td>4.37</td>
<td>4.32</td>
<td>4.32</td>
<td>4.22</td>
<td>3.97</td>
<td>3.77</td>
<td>3.80</td>
<td>3.91</td>
<td>4.11</td>
<td>4.32</td>
<td>4.79</td>
<td>4.77</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">78</td>
<td>2025-04-25</td>
<td>4.36</td>
<td>4.32</td>
<td>4.32</td>
<td>4.22</td>
<td>3.95</td>
<td>3.74</td>
<td>3.76</td>
<td>3.88</td>
<td>4.06</td>
<td>4.29</td>
<td>4.75</td>
<td>4.74</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">79</td>
<td>2025-04-28</td>
<td>4.37</td>
<td>4.32</td>
<td>4.32</td>
<td>4.22</td>
<td>3.92</td>
<td>3.67</td>
<td>3.67</td>
<td>3.81</td>
<td>4.01</td>
<td>4.23</td>
<td>4.71</td>
<td>4.69</td>
</tr>
</tbody>
</table>

<p>330 rows Ã— 13 columns</p>
</div>
</div>
</div>
<div id="71b545c8228aaf7f" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-28T23:30:36.475060Z&quot;,&quot;start_time&quot;:&quot;2025-04-28T23:30:36.459108Z&quot;}" data-execution_count="13">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>df_yield_spread <span class="op">=</span> df_yield_curve.copy()</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>df_yield_spread[<span class="st">'yield_spread'</span>] <span class="op">=</span> df_yield_spread.<span class="bu">apply</span>(<span class="kw">lambda</span> x: x[<span class="st">'10 Yr'</span>]<span class="op">-</span>x[<span class="st">'2 Yr'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>df_yield_spread <span class="op">=</span> df_yield_spread[[<span class="st">'Date'</span>, <span class="st">'yield_spread'</span>]]</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(df_yield_spread)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>         Date  yield_spread
0  2024-01-02         -0.38
1  2024-01-03         -0.42
2  2024-01-04         -0.39
3  2024-01-05         -0.35
4  2024-01-08         -0.35
..        ...           ...
75 2025-04-22          0.65
76 2025-04-23          0.59
77 2025-04-24          0.55
78 2025-04-25          0.55
79 2025-04-28          0.56

[330 rows x 2 columns]</code></pre>
</div>
</div>
</section>
<section id="calculate-indicators-and-scores" class="level1">
<h1>Calculate Indicators and Scores</h1>
<div id="e562f729d6314c7c" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-29T01:28:26.740494Z&quot;,&quot;start_time&quot;:&quot;2025-04-29T01:28:26.646376Z&quot;}" data-execution_count="36">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_ema(prices, period<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> prices.ewm(span<span class="op">=</span>period, adjust<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_macd(prices, fast<span class="op">=</span><span class="dv">12</span>, slow<span class="op">=</span><span class="dv">26</span>, signal<span class="op">=</span><span class="dv">9</span>):</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    ema_fast <span class="op">=</span> prices.ewm(span<span class="op">=</span>fast, adjust<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    ema_slow <span class="op">=</span> prices.ewm(span<span class="op">=</span>slow, adjust<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    macd_line <span class="op">=</span> ema_fast <span class="op">-</span> ema_slow</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    signal_line <span class="op">=</span> macd_line.ewm(span<span class="op">=</span>signal, adjust<span class="op">=</span><span class="va">False</span>).mean()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    macd_diff <span class="op">=</span> macd_line <span class="op">-</span> signal_line</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> macd_diff</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_adx(high, low, close, period<span class="op">=</span><span class="dv">14</span>):</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate True Range</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    tr1 <span class="op">=</span> <span class="bu">abs</span>(high <span class="op">-</span> low)</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    tr2 <span class="op">=</span> <span class="bu">abs</span>(high <span class="op">-</span> close.shift(<span class="dv">1</span>))</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    tr3 <span class="op">=</span> <span class="bu">abs</span>(low <span class="op">-</span> close.shift(<span class="dv">1</span>))</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    tr <span class="op">=</span> pd.concat([tr1, tr2, tr3], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    atr <span class="op">=</span> tr.rolling(window<span class="op">=</span>period).mean()</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Plus Directional Movement (+DM) and Minus Directional Movement (-DM)</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    plus_dm <span class="op">=</span> high <span class="op">-</span> high.shift(<span class="dv">1</span>)</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    minus_dm <span class="op">=</span> low.shift(<span class="dv">1</span>) <span class="op">-</span> low</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    plus_dm[plus_dm <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    minus_dm[minus_dm <span class="op">&lt;</span> <span class="dv">0</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Condition when both +DM and -DM are greater than 0</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    condition <span class="op">=</span> (plus_dm <span class="op">&gt;</span> <span class="dv">0</span>) <span class="op">&amp;</span> (minus_dm <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    plus_dm[condition <span class="op">&amp;</span> (plus_dm <span class="op">&lt;</span> minus_dm)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    minus_dm[condition <span class="op">&amp;</span> (minus_dm <span class="op">&lt;</span> plus_dm)] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Smoothed +DM and -DM</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    smoothed_plus_dm <span class="op">=</span> plus_dm.rolling(window<span class="op">=</span>period).<span class="bu">sum</span>()</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    smoothed_minus_dm <span class="op">=</span> minus_dm.rolling(window<span class="op">=</span>period).<span class="bu">sum</span>()</span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Smoothed TR</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    smoothed_tr <span class="op">=</span> atr <span class="op">*</span> period</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Plus Directional Indicator (+DI) and Minus Directional Indicator (-DI)</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    plus_di <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> (smoothed_plus_dm <span class="op">/</span> smoothed_tr)</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    minus_di <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> (smoothed_minus_dm <span class="op">/</span> smoothed_tr)</span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Directional Movement Index (DX)</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    dx <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> (<span class="bu">abs</span>(plus_di <span class="op">-</span> minus_di) <span class="op">/</span> (plus_di <span class="op">+</span> minus_di))</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate Average Directional Index (ADX)</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    adx <span class="op">=</span> dx.rolling(window<span class="op">=</span>period).mean()</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> adx</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_atr(high, low, close, period<span class="op">=</span><span class="dv">14</span>):</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    tr1 <span class="op">=</span> high <span class="op">-</span> low</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    tr2 <span class="op">=</span> <span class="bu">abs</span>(high <span class="op">-</span> close.shift(<span class="dv">1</span>))</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    tr3 <span class="op">=</span> <span class="bu">abs</span>(low <span class="op">-</span> close.shift(<span class="dv">1</span>))</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    tr <span class="op">=</span> pd.concat([tr1, tr2, tr3], axis<span class="op">=</span><span class="dv">1</span>).<span class="bu">max</span>(axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    atr <span class="op">=</span> tr.rolling(window<span class="op">=</span>period).mean()</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> atr</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_iv_percentile(iv_series):</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    percentile <span class="op">=</span> (iv_series.rank(pct<span class="op">=</span><span class="va">True</span>) <span class="op">*</span> <span class="dv">100</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> percentile</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_ema_score(price, ema20):</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>    delta <span class="op">=</span> <span class="dv">100</span> <span class="op">*</span> (price <span class="op">-</span> ema20) <span class="op">/</span> ema20</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate scores based on delta</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    long_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>    short_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Long score calculation</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> delta <span class="op">&lt;</span> <span class="op">-</span><span class="dv">5</span>:</span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="op">-</span><span class="dv">5</span> <span class="op">&lt;=</span> delta <span class="op">&lt;</span> <span class="op">-</span><span class="dv">3</span>:</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="op">-</span><span class="dv">3</span> <span class="op">&lt;=</span> delta <span class="op">&lt;</span> <span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="op">-</span><span class="dv">1</span> <span class="op">&lt;=</span> delta <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Short score calculation</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> delta <span class="op">&gt;</span> <span class="dv">5</span>:</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">3</span> <span class="op">&lt;</span> delta <span class="op">&lt;=</span> <span class="dv">5</span>:</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">1</span> <span class="op">&lt;</span> delta <span class="op">&lt;=</span> <span class="dv">3</span>:</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">0</span> <span class="op">&lt;</span> delta <span class="op">&lt;=</span> <span class="dv">1</span>:</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> long_score, short_score</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_macd_score(macd_diff):</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>    long_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>    short_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Long score calculation</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> macd_diff <span class="op">&lt;</span> <span class="op">-</span><span class="fl">1.5</span>:</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="op">-</span><span class="fl">1.5</span> <span class="op">&lt;=</span> macd_diff <span class="op">&lt;</span> <span class="op">-</span><span class="dv">1</span>:</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="op">-</span><span class="dv">1</span> <span class="op">&lt;=</span> macd_diff <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.5</span>:</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">&lt;=</span> macd_diff <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.1</span>:</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="op">-</span><span class="fl">0.1</span> <span class="op">&lt;=</span> macd_diff <span class="op">&lt;</span> <span class="dv">0</span>:</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Short score calculation</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> macd_diff <span class="op">&gt;</span> <span class="fl">1.5</span>:</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">1</span> <span class="op">&lt;=</span> macd_diff <span class="op">&lt;=</span> <span class="fl">1.5</span>:</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="fl">0.5</span> <span class="op">&lt;=</span> macd_diff <span class="op">&lt;</span> <span class="dv">1</span>:</span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">3</span></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="fl">0.1</span> <span class="op">&lt;=</span> macd_diff <span class="op">&lt;</span> <span class="fl">0.5</span>:</span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">0</span> <span class="op">&lt;=</span> macd_diff <span class="op">&lt;</span> <span class="fl">0.1</span>:</span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> long_score, short_score</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_adx_score(adx):</span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> adx <span class="op">&lt;=</span> <span class="dv">15</span>:</span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">15</span> <span class="op">&lt;</span> adx <span class="op">&lt;=</span> <span class="dv">20</span>:</span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span></span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">20</span> <span class="op">&lt;</span> adx <span class="op">&lt;=</span> <span class="dv">30</span>:</span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">5</span></span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">30</span> <span class="op">&lt;</span> adx <span class="op">&lt;=</span> <span class="dv">40</span>:</span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span></span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># adx &gt; 40</span></span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_atr_score(atr):</span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> atr <span class="op">&gt;</span> <span class="dv">30</span>:</span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">0</span></span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">20</span> <span class="op">&lt;</span> atr <span class="op">&lt;=</span> <span class="dv">30</span>:</span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span></span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">10</span> <span class="op">&lt;</span> atr <span class="op">&lt;=</span> <span class="dv">20</span>:</span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">5</span></span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">5</span> <span class="op">&lt;</span> atr <span class="op">&lt;=</span> <span class="dv">10</span>:</span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">4</span></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># atr &lt; 5</span></span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="dv">2</span></span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_iv_score(iv_percentile):</span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>    long_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>    short_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> iv_percentile <span class="op">&lt;</span> <span class="dv">10</span>:</span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">10</span> <span class="op">&lt;=</span> iv_percentile <span class="op">&lt;</span> <span class="dv">30</span>:</span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">30</span> <span class="op">&lt;=</span> iv_percentile <span class="op">&lt;</span> <span class="dv">70</span>:</span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="dv">70</span> <span class="op">&lt;=</span> iv_percentile <span class="op">&lt;</span> <span class="dv">90</span>:</span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># iv_percentile &gt;= 90</span></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> long_score, short_score</span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_yield_spread_score(yield_spread):</span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>    long_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>    short_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> yield_spread <span class="op">&gt;</span> <span class="fl">1.5</span>:</span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="fl">0.5</span> <span class="op">&lt;</span> yield_spread <span class="op">&lt;=</span> <span class="fl">1.5</span>:</span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">&lt;=</span> yield_spread <span class="op">&lt;=</span> <span class="fl">0.5</span>:</span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">2</span></span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="op">-</span><span class="fl">1.5</span> <span class="op">&lt;=</span> yield_spread <span class="op">&lt;</span> <span class="op">-</span><span class="fl">0.5</span>:</span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">1</span></span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">4</span></span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:  <span class="co"># yield_spread &lt; -1.5</span></span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>        long_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a>        short_score <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb9-196"><a href="#cb9-196" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-197"><a href="#cb9-197" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> long_score, short_score</span>
<span id="cb9-198"><a href="#cb9-198" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-199"><a href="#cb9-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-200"><a href="#cb9-200" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_total_score(ema_long, ema_short, macd_long, macd_short, adx, atr, iv_long, iv_short, yield_long, yield_short):</span>
<span id="cb9-201"><a href="#cb9-201" aria-hidden="true" tabindex="-1"></a>    long_score <span class="op">=</span> <span class="fl">.25</span> <span class="op">*</span> ema_long <span class="op">+</span> <span class="fl">.25</span> <span class="op">*</span> macd_long <span class="op">+</span> <span class="fl">.1</span> <span class="op">*</span> adx <span class="op">+</span> <span class="fl">.1</span> <span class="op">*</span> atr <span class="op">+</span> <span class="fl">.15</span> <span class="op">*</span> iv_long <span class="op">+</span> <span class="fl">.15</span> <span class="op">*</span> yield_long</span>
<span id="cb9-202"><a href="#cb9-202" aria-hidden="true" tabindex="-1"></a>    short_score <span class="op">=</span> <span class="fl">.25</span> <span class="op">*</span> ema_short <span class="op">+</span> <span class="fl">.25</span> <span class="op">*</span> macd_short <span class="op">+</span> <span class="fl">.1</span> <span class="op">*</span> adx <span class="op">+</span> <span class="fl">.1</span> <span class="op">*</span> atr <span class="op">+</span> <span class="fl">.15</span> <span class="op">*</span> iv_short <span class="op">+</span> <span class="fl">.15</span> <span class="op">*</span> yield_short</span>
<span id="cb9-203"><a href="#cb9-203" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-204"><a href="#cb9-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> long_score <span class="op">&gt;</span> short_score:</span>
<span id="cb9-205"><a href="#cb9-205" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> long_score, <span class="st">'LONG'</span></span>
<span id="cb9-206"><a href="#cb9-206" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb9-207"><a href="#cb9-207" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">*</span>short_score, <span class="st">'SHORT'</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="visualization" class="level1">
<h1>Visualization</h1>
<div id="8ed41cd2b66bd285" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-28T23:34:30.028704Z&quot;,&quot;start_time&quot;:&quot;2025-04-28T23:34:29.999501Z&quot;}" data-execution_count="15">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> plot_performance(ledger):</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    plt.figure(figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">7</span>))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    plt.plot(ledger.index, ledger[<span class="st">'Market Value'</span>], label<span class="op">=</span><span class="st">'End of Day Portfolio Market Value'</span>)</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    plt.title(<span class="st">'End of Day Portfolio Market Value Over Time'</span>)</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    plt.xlabel(<span class="st">'Date'</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    plt.ylabel(<span class="st">'Value ($)'</span>)</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    plt.legend()</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    plt.grid(<span class="va">True</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    plt.xticks(rotation<span class="op">=</span><span class="dv">45</span>)</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="backtest-strategy-function" class="level1">
<h1>Backtest Strategy Function</h1>
<div id="fa841554f8b7e6a3" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-29T01:15:41.418745Z&quot;,&quot;start_time&quot;:&quot;2025-04-29T01:15:41.291384Z&quot;}" data-execution_count="29">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> backtest_strategy(daily_data_dict, hourly_data_dict, daily_iv_dict, df_yield_spread, asset_symbols, initial_capital<span class="op">=</span><span class="dv">1000000</span>):</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Ensure timestamps in df_yield_spread are in datetime format</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    df_yield_spread[<span class="st">'Date'</span>] <span class="op">=</span> pd.to_datetime(df_yield_spread[<span class="st">'Date'</span>])</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create asset blotters</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    asset_blotter_dict <span class="op">=</span> {}</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> asset <span class="kw">in</span> asset_symbols:</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        blotter <span class="op">=</span> pd.DataFrame(</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>            data<span class="op">=</span>{</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                <span class="st">'entry_timestamp'</span>: <span class="va">None</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                <span class="st">'qty'</span>: <span class="dv">0</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>                <span class="st">'exit_timestamp'</span>: <span class="va">None</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>                <span class="st">'entry_price'</span>: <span class="va">None</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>                <span class="st">'exit_price'</span>: <span class="va">None</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>                <span class="st">'success'</span>: pd.NA</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>            },</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>            index<span class="op">=</span>daily_data_dict[asset][<span class="st">'trd_prd'</span>].unique()[<span class="dv">2</span>:]</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        asset_blotter_dict[asset] <span class="op">=</span> blotter</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create portfolio blotter for rebalancing weights</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>    portfolio_periods <span class="op">=</span> daily_data_dict[asset_symbols[<span class="dv">0</span>]][<span class="st">'trd_prd'</span>].unique()[<span class="dv">2</span>:]</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"backtest periods: </span><span class="sc">{</span>portfolio_periods<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    portfolio_blotter <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>portfolio_periods, columns<span class="op">=</span>asset_symbols)</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    portfolio_blotter.index.name <span class="op">=</span> <span class="st">'trd_prd'</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all unique dates from the daily data for the ledger</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>    all_dates <span class="op">=</span> []</span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> asset <span class="kw">in</span> asset_symbols:</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure timestamp column is datetime</span></span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>        daily_data_dict[asset][<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(daily_data_dict[asset][<span class="st">'timestamp'</span>])</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Extract dates</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>        portfolio_dates <span class="op">=</span> daily_data_dict[asset][daily_data_dict[asset][<span class="st">'trd_prd'</span>]<span class="op">&gt;=</span>portfolio_periods[<span class="dv">0</span>]][<span class="st">'timestamp'</span>]</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        all_dates.extend(portfolio_dates.dt.date.tolist())</span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>    all_dates <span class="op">=</span> <span class="bu">sorted</span>(<span class="bu">list</span>(<span class="bu">set</span>(all_dates)))</span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create portfolio ledger with date index</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>    ledger_columns <span class="op">=</span> [<span class="st">'Cash'</span>]</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> asset <span class="kw">in</span> asset_symbols:</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        ledger_columns.append(<span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss"> Qty"</span>)</span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> asset <span class="kw">in</span> asset_symbols:</span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        ledger_columns.append(<span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss"> Price"</span>)</span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    ledger_columns.extend([<span class="st">'Portfolio Value'</span>, <span class="st">'Market Value'</span>])</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>    ledger <span class="op">=</span> pd.DataFrame(index<span class="op">=</span>all_dates, columns<span class="op">=</span>ledger_columns)</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>    ledger.index.name <span class="op">=</span> <span class="st">'Date'</span></span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    ledger[<span class="st">'Cash'</span>] <span class="op">=</span> np.nan</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    ledger.loc[<span class="bu">min</span>(all_dates), <span class="st">'Cash'</span>] <span class="op">=</span> initial_capital</span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> asset <span class="kw">in</span> asset_symbols:</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a>        ledger[<span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss"> Qty"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Fill initial prices in ledger</span></span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> date <span class="kw">in</span> all_dates:</span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> asset <span class="kw">in</span> asset_symbols:</span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a>            mask <span class="op">=</span> daily_data_dict[asset][<span class="st">'timestamp'</span>].dt.date <span class="op">==</span> date</span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> mask.<span class="bu">any</span>():</span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>                price_row <span class="op">=</span> daily_data_dict[asset][mask]</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> <span class="kw">not</span> price_row.empty:</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a>                    ledger.loc[date, <span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss"> Price"</span>] <span class="op">=</span> price_row[<span class="st">'close'</span>].values[<span class="dv">0</span>]</span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each trading period</span></span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> period_idx, period <span class="kw">in</span> <span class="bu">enumerate</span>(portfolio_periods):</span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get previous period for calculations</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a>        prev_period <span class="op">=</span> daily_data_dict[asset_symbols[<span class="dv">0</span>]][<span class="st">'trd_prd'</span>].unique()[period_idx<span class="op">+</span><span class="dv">1</span>]</span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a>        prev_2_period <span class="op">=</span> daily_data_dict[asset_symbols[<span class="dv">0</span>]][<span class="st">'trd_prd'</span>].unique()[period_idx]</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># print(f"Processing period: {period:.2f} Previous period: {prev_period:.2f}, Previous 2 period: {prev_2_period:.2f}")</span></span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate indicators and weights for each asset</span></span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>        asset_scores <span class="op">=</span> {}</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>        total_score <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> asset <span class="kw">in</span> asset_symbols:</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get data for previous period</span></span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>            prev_data <span class="op">=</span> daily_data_dict[asset][daily_data_dict[asset][<span class="st">'trd_prd'</span>] <span class="op">&lt;=</span> prev_period]</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>            last_data <span class="op">=</span> daily_data_dict[asset][daily_data_dict[asset][<span class="st">'trd_prd'</span>] <span class="op">==</span> prev_period]</span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>            vol <span class="op">=</span> last_data[<span class="st">'close'</span>].std()<span class="op">/</span><span class="dv">100</span></span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> prev_data.empty:</span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate indicators</span></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>            last_close <span class="op">=</span> prev_data[<span class="st">'close'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>            <span class="co"># EMA indicator</span></span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>            ema20 <span class="op">=</span> calculate_ema(prev_data[<span class="st">'close'</span>], <span class="dv">20</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>            ema_long, ema_short <span class="op">=</span> calculate_ema_score(last_close, ema20)</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>            <span class="co"># MACD indicator</span></span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>            macd_diff <span class="op">=</span> calculate_macd(prev_data[<span class="st">'close'</span>], fast <span class="op">=</span> <span class="dv">11</span>, slow <span class="op">=</span> <span class="dv">44</span>, signal <span class="op">=</span> <span class="dv">22</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>            macd_long, macd_short <span class="op">=</span> calculate_macd_score(macd_diff)</span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ADX indicator</span></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a>            adx <span class="op">=</span> calculate_adx(prev_data[<span class="st">'high'</span>], prev_data[<span class="st">'low'</span>], prev_data[<span class="st">'close'</span>], period <span class="op">=</span> <span class="dv">11</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>            adx_score <span class="op">=</span> calculate_adx_score(adx)</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>            <span class="co"># ATR indicator</span></span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>            atr <span class="op">=</span> calculate_atr(prev_data[<span class="st">'high'</span>], prev_data[<span class="st">'low'</span>], prev_data[<span class="st">'close'</span>], period <span class="op">=</span> <span class="dv">11</span>).iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>            atr_score <span class="op">=</span> calculate_atr_score(atr)</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>            <span class="co"># IV indicator</span></span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>            iv_window <span class="op">=</span> daily_iv_dict[asset][</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>                (daily_iv_dict[asset][<span class="st">'trd_prd'</span>] <span class="op">&gt;=</span> prev_2_period) <span class="op">&amp;</span></span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a>                (daily_iv_dict[asset][<span class="st">'trd_prd'</span>] <span class="op">&lt;=</span> period)</span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a>            ][<span class="st">'close'</span>].dropna()</span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>            iv_percentile <span class="op">=</span> calculate_iv_percentile(iv_window)</span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a>            iv_long, iv_short <span class="op">=</span> calculate_iv_score(iv_percentile)</span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Yield spread indicator</span></span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Use timestamp directly for comparison with datetime Series</span></span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>            last_timestamp <span class="op">=</span> prev_data[<span class="st">'timestamp'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a>            yield_date_mask <span class="op">=</span> df_yield_spread[<span class="st">'Date'</span>] <span class="op">&lt;=</span> last_timestamp</span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> yield_date_mask.<span class="bu">any</span>():</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a>                last_yield_date <span class="op">=</span> df_yield_spread.loc[yield_date_mask, <span class="st">'Date'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a>                yield_spread <span class="op">=</span> df_yield_spread[df_yield_spread[<span class="st">'Date'</span>] <span class="op">==</span> last_yield_date][<span class="st">'yield_spread'</span>].values[<span class="dv">0</span>]</span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>                yield_long, yield_short <span class="op">=</span> calculate_yield_spread_score(yield_spread)</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a>                yield_long, yield_short <span class="op">=</span> <span class="dv">0</span>, <span class="dv">0</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate total score and direction</span></span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>            score, direction <span class="op">=</span> calculate_total_score(</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>                ema_long, ema_short, macd_long, macd_short, adx_score, atr_score,</span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>                iv_long, iv_short, yield_long, yield_short</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>            )</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>            <span class="co"># print(f"period: {period} {asset} score: {score}, direction: {direction}")</span></span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Store score, direction and ATR for stop loss/take profit</span></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>            asset_scores[asset] <span class="op">=</span> {</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a>                <span class="st">'score'</span>: score,</span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>                <span class="st">'direction'</span>: direction,</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>                <span class="st">'atr'</span>: atr</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>            }</span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>            total_score <span class="op">+=</span> score</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate weights</span></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a>        weights <span class="op">=</span> {}</span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> asset <span class="kw">in</span> asset_scores:</span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>            weight <span class="op">=</span> asset_scores[asset][<span class="st">'score'</span>] <span class="op">/</span> <span class="bu">abs</span>(total_score)</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>            weights[asset] <span class="op">=</span> weight</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update portfolio blotter</span></span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>            portfolio_blotter.loc[period, asset] <span class="op">=</span> weight</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get first trading day of the period for each asset</span></span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> asset <span class="kw">in</span> asset_symbols:</span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> asset <span class="kw">not</span> <span class="kw">in</span> weights <span class="kw">or</span> asset <span class="kw">not</span> <span class="kw">in</span> asset_scores:</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get first trading day of the period</span></span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a>            period_data <span class="op">=</span> daily_data_dict[asset][daily_data_dict[asset][<span class="st">'trd_prd'</span>] <span class="op">==</span> period]</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> period_data.empty:</span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a>                <span class="cf">continue</span></span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>            entry_timestamp <span class="op">=</span> period_data[<span class="st">'timestamp'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>            entry_date <span class="op">=</span> entry_timestamp.date()</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>            entry_price <span class="op">=</span> period_data[<span class="st">'open'</span>].iloc[<span class="dv">0</span>]</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get current portfolio value</span></span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>            mask <span class="op">=</span> [d <span class="op">&lt;=</span> entry_date <span class="cf">for</span> d <span class="kw">in</span> ledger.index]</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">any</span>(mask):</span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a>                last_market_value <span class="op">=</span> ledger.loc[mask, <span class="st">'Market Value'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>                <span class="co"># print(last_market_value)</span></span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pd.isna(last_market_value):</span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Use initial capital if no market value available yet</span></span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a>                    last_market_value <span class="op">=</span> initial_capital</span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>                last_market_value <span class="op">=</span> initial_capital</span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Calculate target position</span></span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a>            target_value <span class="op">=</span> weights[asset] <span class="op">*</span> last_market_value</span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a>            target_qty <span class="op">=</span> <span class="bu">int</span>(target_value <span class="op">/</span> entry_price)</span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update asset blotter</span></span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>            asset_blotter_dict[asset].loc[period, <span class="st">'entry_timestamp'</span>] <span class="op">=</span> entry_timestamp</span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>            asset_blotter_dict[asset].loc[period, <span class="st">'entry_price'</span>] <span class="op">=</span> entry_price</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>            asset_blotter_dict[asset].loc[period, <span class="st">'qty'</span>] <span class="op">=</span> target_qty</span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>            ledger_dates_entry <span class="op">=</span> [d <span class="cf">for</span> d <span class="kw">in</span> ledger.index <span class="cf">if</span> d <span class="op">&gt;=</span> entry_date]</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> d <span class="kw">in</span> ledger_dates_entry:</span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>                ledger.loc[d, <span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss"> Qty"</span>] <span class="op">=</span> target_qty</span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a>            prev_cash <span class="op">=</span> ledger[<span class="st">'Cash'</span>].ffill().loc[entry_date]</span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a>            ledger.loc[entry_date, <span class="st">'Cash'</span>] <span class="op">=</span> prev_cash <span class="op">-</span> target_qty <span class="op">*</span> entry_price</span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Process stop loss/take profit for this asset</span></span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Ensure hourly data timestamp is datetime</span></span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a>            hourly_data_dict[asset][<span class="st">'timestamp'</span>] <span class="op">=</span> pd.to_datetime(hourly_data_dict[asset][<span class="st">'timestamp'</span>])</span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a>            period_hourly_data <span class="op">=</span> hourly_data_dict[asset][hourly_data_dict[asset][<span class="st">'trd_prd'</span>] <span class="op">==</span> period]</span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a>            direction <span class="op">=</span> asset_scores[asset][<span class="st">'direction'</span>]</span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a>            atr <span class="op">=</span> asset_scores[asset][<span class="st">'atr'</span>]</span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Define stop loss/take profit levels</span></span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> direction <span class="op">==</span> <span class="st">'LONG'</span>:</span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a>                stop_loss_level <span class="op">=</span> entry_price <span class="op">*</span> (<span class="dv">1</span><span class="op">-</span> <span class="fl">.5</span> <span class="op">*</span> vol)</span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a>                take_profit_level <span class="op">=</span> entry_price <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> <span class="fl">.5</span> <span class="op">*</span> vol)</span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:  <span class="co"># SHORT</span></span>
<span id="cb11-203"><a href="#cb11-203" aria-hidden="true" tabindex="-1"></a>                stop_loss_level <span class="op">=</span> entry_price <span class="op">*</span> (<span class="dv">1</span> <span class="op">+</span> <span class="fl">.5</span> <span class="op">*</span> vol)</span>
<span id="cb11-204"><a href="#cb11-204" aria-hidden="true" tabindex="-1"></a>                take_profit_level <span class="op">=</span> entry_price<span class="op">*</span> (<span class="dv">1</span> <span class="op">-</span> <span class="fl">.5</span> <span class="op">*</span> vol)</span>
<span id="cb11-205"><a href="#cb11-205" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-206"><a href="#cb11-206" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Check for stop loss/take profit triggers</span></span>
<span id="cb11-207"><a href="#cb11-207" aria-hidden="true" tabindex="-1"></a>            exit_triggered <span class="op">=</span> <span class="va">False</span></span>
<span id="cb11-208"><a href="#cb11-208" aria-hidden="true" tabindex="-1"></a>            exit_timestamp <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-209"><a href="#cb11-209" aria-hidden="true" tabindex="-1"></a>            exit_price <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-210"><a href="#cb11-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-211"><a href="#cb11-211" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> _, row <span class="kw">in</span> period_hourly_data.iterrows():</span>
<span id="cb11-212"><a href="#cb11-212" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> direction <span class="op">==</span> <span class="st">'LONG'</span>:</span>
<span id="cb11-213"><a href="#cb11-213" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check for take profit</span></span>
<span id="cb11-214"><a href="#cb11-214" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> row[<span class="st">'close'</span>] <span class="op">&gt;=</span> take_profit_level:</span>
<span id="cb11-215"><a href="#cb11-215" aria-hidden="true" tabindex="-1"></a>                        exit_triggered <span class="op">=</span> <span class="va">True</span></span>
<span id="cb11-216"><a href="#cb11-216" aria-hidden="true" tabindex="-1"></a>                        exit_timestamp <span class="op">=</span> row[<span class="st">'timestamp'</span>]</span>
<span id="cb11-217"><a href="#cb11-217" aria-hidden="true" tabindex="-1"></a>                        exit_price <span class="op">=</span> row[<span class="st">'close'</span>]</span>
<span id="cb11-218"><a href="#cb11-218" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb11-219"><a href="#cb11-219" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check for stop loss</span></span>
<span id="cb11-220"><a href="#cb11-220" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> row[<span class="st">'close'</span>] <span class="op">&lt;=</span> stop_loss_level:</span>
<span id="cb11-221"><a href="#cb11-221" aria-hidden="true" tabindex="-1"></a>                        exit_triggered <span class="op">=</span> <span class="va">True</span></span>
<span id="cb11-222"><a href="#cb11-222" aria-hidden="true" tabindex="-1"></a>                        exit_timestamp <span class="op">=</span> row[<span class="st">'timestamp'</span>]</span>
<span id="cb11-223"><a href="#cb11-223" aria-hidden="true" tabindex="-1"></a>                        exit_price <span class="op">=</span> row[<span class="st">'close'</span>]</span>
<span id="cb11-224"><a href="#cb11-224" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb11-225"><a href="#cb11-225" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:  <span class="co"># SHORT</span></span>
<span id="cb11-226"><a href="#cb11-226" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check for take profit</span></span>
<span id="cb11-227"><a href="#cb11-227" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> row[<span class="st">'close'</span>] <span class="op">&lt;=</span> take_profit_level:</span>
<span id="cb11-228"><a href="#cb11-228" aria-hidden="true" tabindex="-1"></a>                        exit_triggered <span class="op">=</span> <span class="va">True</span></span>
<span id="cb11-229"><a href="#cb11-229" aria-hidden="true" tabindex="-1"></a>                        exit_timestamp <span class="op">=</span> row[<span class="st">'timestamp'</span>]</span>
<span id="cb11-230"><a href="#cb11-230" aria-hidden="true" tabindex="-1"></a>                        exit_price <span class="op">=</span> row[<span class="st">'close'</span>]</span>
<span id="cb11-231"><a href="#cb11-231" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb11-232"><a href="#cb11-232" aria-hidden="true" tabindex="-1"></a>                    <span class="co"># Check for stop loss</span></span>
<span id="cb11-233"><a href="#cb11-233" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">elif</span> row[<span class="st">'close'</span>] <span class="op">&gt;=</span> stop_loss_level:</span>
<span id="cb11-234"><a href="#cb11-234" aria-hidden="true" tabindex="-1"></a>                        exit_triggered <span class="op">=</span> <span class="va">True</span></span>
<span id="cb11-235"><a href="#cb11-235" aria-hidden="true" tabindex="-1"></a>                        exit_timestamp <span class="op">=</span> row[<span class="st">'timestamp'</span>]</span>
<span id="cb11-236"><a href="#cb11-236" aria-hidden="true" tabindex="-1"></a>                        exit_price <span class="op">=</span> row[<span class="st">'close'</span>]</span>
<span id="cb11-237"><a href="#cb11-237" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">break</span></span>
<span id="cb11-238"><a href="#cb11-238" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-239"><a href="#cb11-239" aria-hidden="true" tabindex="-1"></a>            <span class="co"># If no exit triggered, use the last day of the period</span></span>
<span id="cb11-240"><a href="#cb11-240" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> exit_triggered <span class="kw">and</span> <span class="kw">not</span> period_data.empty:</span>
<span id="cb11-241"><a href="#cb11-241" aria-hidden="true" tabindex="-1"></a>                exit_timestamp <span class="op">=</span> period_data[<span class="st">'timestamp'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-242"><a href="#cb11-242" aria-hidden="true" tabindex="-1"></a>                exit_price <span class="op">=</span> period_data[<span class="st">'close'</span>].iloc[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb11-243"><a href="#cb11-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-244"><a href="#cb11-244" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Update asset blotter with exit information</span></span>
<span id="cb11-245"><a href="#cb11-245" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> exit_timestamp <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span> <span class="kw">and</span> exit_price <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb11-246"><a href="#cb11-246" aria-hidden="true" tabindex="-1"></a>                asset_blotter_dict[asset].loc[period, <span class="st">'exit_timestamp'</span>] <span class="op">=</span> exit_timestamp</span>
<span id="cb11-247"><a href="#cb11-247" aria-hidden="true" tabindex="-1"></a>                asset_blotter_dict[asset].loc[period, <span class="st">'exit_price'</span>] <span class="op">=</span> exit_price</span>
<span id="cb11-248"><a href="#cb11-248" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-249"><a href="#cb11-249" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Determine if trade was successful</span></span>
<span id="cb11-250"><a href="#cb11-250" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> direction <span class="op">==</span> <span class="st">'LONG'</span>:</span>
<span id="cb11-251"><a href="#cb11-251" aria-hidden="true" tabindex="-1"></a>                    success <span class="op">=</span> exit_price <span class="op">&gt;</span> entry_price</span>
<span id="cb11-252"><a href="#cb11-252" aria-hidden="true" tabindex="-1"></a>                <span class="cf">else</span>:  <span class="co"># SHORT</span></span>
<span id="cb11-253"><a href="#cb11-253" aria-hidden="true" tabindex="-1"></a>                    success <span class="op">=</span> exit_price <span class="op">&lt;</span> entry_price</span>
<span id="cb11-254"><a href="#cb11-254" aria-hidden="true" tabindex="-1"></a>                asset_blotter_dict[asset].loc[period, <span class="st">'success'</span>] <span class="op">=</span> success</span>
<span id="cb11-255"><a href="#cb11-255" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-256"><a href="#cb11-256" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Update ledger for exit</span></span>
<span id="cb11-257"><a href="#cb11-257" aria-hidden="true" tabindex="-1"></a>                exit_date <span class="op">=</span> exit_timestamp.date()</span>
<span id="cb11-258"><a href="#cb11-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-259"><a href="#cb11-259" aria-hidden="true" tabindex="-1"></a>                <span class="co"># å¯¹æ‰€æœ‰åŽç»­æ—¥æœŸæ›´æ–°æŒä»“æ•°é‡ä¸º0</span></span>
<span id="cb11-260"><a href="#cb11-260" aria-hidden="true" tabindex="-1"></a>                ledger_dates_exit <span class="op">=</span> [d <span class="cf">for</span> d <span class="kw">in</span> ledger.index <span class="cf">if</span> d <span class="op">&gt;=</span> exit_date]</span>
<span id="cb11-261"><a href="#cb11-261" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> d <span class="kw">in</span> ledger_dates_exit:</span>
<span id="cb11-262"><a href="#cb11-262" aria-hidden="true" tabindex="-1"></a>                    ledger.loc[d, <span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss"> Qty"</span>] <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-263"><a href="#cb11-263" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-264"><a href="#cb11-264" aria-hidden="true" tabindex="-1"></a>                current <span class="op">=</span> ledger.loc[exit_date, <span class="st">'Cash'</span>]</span>
<span id="cb11-265"><a href="#cb11-265" aria-hidden="true" tabindex="-1"></a>                <span class="cf">if</span> pd.isna(current):</span>
<span id="cb11-266"><a href="#cb11-266" aria-hidden="true" tabindex="-1"></a>                    current <span class="op">=</span> ledger[<span class="st">'Cash'</span>].ffill().loc[exit_date]</span>
<span id="cb11-267"><a href="#cb11-267" aria-hidden="true" tabindex="-1"></a>                ledger.loc[exit_date, <span class="st">'Cash'</span>] <span class="op">=</span> current <span class="op">+</span> target_qty <span class="op">*</span> exit_price</span>
<span id="cb11-268"><a href="#cb11-268" aria-hidden="true" tabindex="-1"></a>        ledger <span class="op">=</span> ledger.ffill()</span>
<span id="cb11-269"><a href="#cb11-269" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-270"><a href="#cb11-270" aria-hidden="true" tabindex="-1"></a>    ledger[<span class="st">'Cash'</span>] <span class="op">=</span> ledger[<span class="st">'Cash'</span>].ffill()</span>
<span id="cb11-271"><a href="#cb11-271" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-272"><a href="#cb11-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> date <span class="kw">in</span> ledger.index:</span>
<span id="cb11-273"><a href="#cb11-273" aria-hidden="true" tabindex="-1"></a>        portfolio_value <span class="op">=</span> <span class="dv">0</span></span>
<span id="cb11-274"><a href="#cb11-274" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> asset <span class="kw">in</span> asset_symbols:</span>
<span id="cb11-275"><a href="#cb11-275" aria-hidden="true" tabindex="-1"></a>            qty <span class="op">=</span> ledger.loc[date, <span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss"> Qty"</span>]</span>
<span id="cb11-276"><a href="#cb11-276" aria-hidden="true" tabindex="-1"></a>            price <span class="op">=</span> ledger.loc[date, <span class="ss">f"</span><span class="sc">{</span>asset<span class="sc">}</span><span class="ss"> Price"</span>]</span>
<span id="cb11-277"><a href="#cb11-277" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="kw">not</span> pd.isna(qty) <span class="kw">and</span> <span class="kw">not</span> pd.isna(price):</span>
<span id="cb11-278"><a href="#cb11-278" aria-hidden="true" tabindex="-1"></a>                portfolio_value <span class="op">+=</span> qty <span class="op">*</span> price</span>
<span id="cb11-279"><a href="#cb11-279" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-280"><a href="#cb11-280" aria-hidden="true" tabindex="-1"></a>        ledger.loc[date, <span class="st">'Portfolio Value'</span>] <span class="op">=</span> portfolio_value</span>
<span id="cb11-281"><a href="#cb11-281" aria-hidden="true" tabindex="-1"></a>        ledger.loc[date, <span class="st">'Market Value'</span>] <span class="op">=</span> ledger.loc[date, <span class="st">'Cash'</span>] <span class="op">+</span> portfolio_value</span>
<span id="cb11-282"><a href="#cb11-282" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-283"><a href="#cb11-283" aria-hidden="true" tabindex="-1"></a>    ledger <span class="op">=</span> ledger.ffill()</span>
<span id="cb11-284"><a href="#cb11-284" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-285"><a href="#cb11-285" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> asset_blotter_dict, portfolio_blotter, ledger</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="implement-startegy" class="level1">
<h1>Implement Startegy</h1>
<div id="c4a88de71c62c35b" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-29T01:28:40.119067Z&quot;,&quot;start_time&quot;:&quot;2025-04-29T01:28:34.217311Z&quot;}" data-execution_count="37">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Main execution</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> warnings</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>warnings.filterwarnings(<span class="st">'ignore'</span>)</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>asset_blotter_dict, portfolio_blotter, ledger <span class="op">=</span> backtest_strategy(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    daily_data_dict, hourly_data_dict, daily_iv_dict, df_yield_spread, asset_symbols</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot performance</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>plot_performance(ledger)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Print summary</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Portfolio Blotter (Target Weights):"</span>)</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(portfolio_blotter.head())</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Sample Asset Blotter (AAPL):"</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(asset_blotter_dict[<span class="st">'AAPL'</span>].head())</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Ledger Sample:"</span>)</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(ledger.head())</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Final Portfolio Value:"</span>, ledger[<span class="st">'Market Value'</span>].iloc[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>portfolio_blotter.to_csv(<span class="st">'blotter.csv'</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>ledger.to_csv(<span class="st">'ledger.csv'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>backtest periods: [2024.11 2024.12 2025.01 2025.02 2025.03 2025.04]</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="final_code_files/figure-html/cell-11-output-2.png" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Portfolio Blotter (Target Weights):
             AAPL      MSFT       JPM       XOM       JNJ        PG      NVDA  \
trd_prd                                                                         
2024.11  0.106719  0.124506 -0.088933  0.118577  0.098814   0.13834  0.098814   
2024.12 -0.186246 -0.140401 -0.191977  0.143266 -0.106017 -0.200573  0.183381   
2025.01 -0.126949  0.144766  0.113586  0.124722  0.091314  0.113586  0.142539   
2025.02  0.239583  0.354167 -0.348958 -0.213542   -0.3125 -0.239583  0.385417   
2025.03 -0.522936   0.53211  0.477064 -0.422018 -0.559633 -0.633028  0.550459   

              CAT        HD      AMZN  
trd_prd                                
2024.11  0.156126  0.144269  0.102767  
2024.12 -0.186246 -0.186246  -0.12894  
2025.01  0.144766  0.131403  0.120267  
2025.02 -0.244792 -0.286458 -0.333333  
2025.03  0.495413  0.541284  0.541284  

Sample Asset Blotter (AAPL):
             entry_timestamp   qty       exit_timestamp entry_price  \
2024.11  2024-11-01 00:00:00   482  2024-11-06 09:30:00       221.0   
2024.12  2024-12-02 00:00:00  -784  2024-12-04 09:30:00      237.27   
2025.01  2025-01-02 00:00:00  -509  2025-01-08 09:30:00      248.93   
2025.02  2025-02-03 00:00:00  1041  2025-02-13 10:00:00      229.99   
2025.03  2025-03-03 00:00:00 -2162  2025-03-10 10:00:00      241.81   

        exit_price success  
2024.11     224.45    True  
2024.12     243.56   False  
2025.01     240.93    True  
2025.02     239.28    True  
2025.03     226.19    True  

Ledger Sample:
                  Cash  AAPL Qty  MSFT Qty  JPM Qty  XOM Qty  JNJ Qty  PG Qty  \
Date                                                                            
2024-11-01   217620.41       482       304     -397        0      615     836   
2024-11-04   968506.40       482       304        0        0        0     836   
2024-11-05  1026309.84       482       304        0        0        0     836   
2024-11-06  1403432.06         0         0        0        0        0       0   
2024-11-07  1403432.06         0         0        0        0        0       0   

            NVDA Qty  CAT Qty  HD Qty  ...  JPM Price  XOM Price  JNJ Price  \
Date                                   ...                                    
2024-11-01         0      412     365  ...     222.94     114.95     160.13   
2024-11-04         0      412     365  ...     219.78     118.61     158.24   
2024-11-05         0        0     365  ...     221.49     118.96     158.35   
2024-11-06         0        0       0  ...     247.06     121.00     157.88   
2024-11-07         0        0       0  ...     236.38     121.15     156.73   

            PG Price  NVDA Price  CAT Price  HD Price  AMZN Price  \
Date                                                                
2024-11-01    165.10      135.40     379.63    392.59      197.93   
2024-11-04    165.08      136.05     376.52    395.57      195.78   
2024-11-05    165.76      139.91     383.37    400.09      199.50   
2024-11-06    161.05      145.61     416.88    388.37      207.09   
2024-11-07    163.41      148.88     408.21    399.44      210.05   

            Portfolio Value  Market Value  
Date                                       
2024-11-01        782026.26     999646.67  
2024-11-04        668696.83    1637203.23  
2024-11-05        517394.95    1543704.79  
2024-11-06             0.00    1403432.06  
2024-11-07             0.00    1403432.06  

[5 rows x 23 columns]

Final Portfolio Value: 1403432.0599999998</code></pre>
</div>
</div>
<div id="28459cb06f25b118" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-29T01:29:15.756820Z&quot;,&quot;start_time&quot;:&quot;2025-04-29T01:29:15.729604Z&quot;}" data-execution_count="39">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>portfolio_blotter</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="co"># portfolio_blotter.sum(axis=1)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">AAPL</th>
<th data-quarto-table-cell-role="th">MSFT</th>
<th data-quarto-table-cell-role="th">JPM</th>
<th data-quarto-table-cell-role="th">XOM</th>
<th data-quarto-table-cell-role="th">JNJ</th>
<th data-quarto-table-cell-role="th">PG</th>
<th data-quarto-table-cell-role="th">NVDA</th>
<th data-quarto-table-cell-role="th">CAT</th>
<th data-quarto-table-cell-role="th">HD</th>
<th data-quarto-table-cell-role="th">AMZN</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">trd_prd</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2024.11</td>
<td>0.106719</td>
<td>0.124506</td>
<td>-0.088933</td>
<td>0.118577</td>
<td>0.098814</td>
<td>0.13834</td>
<td>0.098814</td>
<td>0.156126</td>
<td>0.144269</td>
<td>0.102767</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2024.12</td>
<td>-0.186246</td>
<td>-0.140401</td>
<td>-0.191977</td>
<td>0.143266</td>
<td>-0.106017</td>
<td>-0.200573</td>
<td>0.183381</td>
<td>-0.186246</td>
<td>-0.186246</td>
<td>-0.12894</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2025.01</td>
<td>-0.126949</td>
<td>0.144766</td>
<td>0.113586</td>
<td>0.124722</td>
<td>0.091314</td>
<td>0.113586</td>
<td>0.142539</td>
<td>0.144766</td>
<td>0.131403</td>
<td>0.120267</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2025.02</td>
<td>0.239583</td>
<td>0.354167</td>
<td>-0.348958</td>
<td>-0.213542</td>
<td>-0.3125</td>
<td>-0.239583</td>
<td>0.385417</td>
<td>-0.244792</td>
<td>-0.286458</td>
<td>-0.333333</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2025.03</td>
<td>-0.522936</td>
<td>0.53211</td>
<td>0.477064</td>
<td>-0.422018</td>
<td>-0.559633</td>
<td>-0.633028</td>
<td>0.550459</td>
<td>0.495413</td>
<td>0.541284</td>
<td>0.541284</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2025.04</td>
<td>0.847458</td>
<td>0.79661</td>
<td>-0.508475</td>
<td>-1.033898</td>
<td>-0.694915</td>
<td>0.779661</td>
<td>1.118644</td>
<td>-0.847458</td>
<td>-0.677966</td>
<td>1.220339</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<div id="cea7bf01c5a7a560" class="cell" data-executetime="{&quot;end_time&quot;:&quot;2025-04-29T01:29:18.920091Z&quot;,&quot;start_time&quot;:&quot;2025-04-29T01:29:18.862358Z&quot;}" data-execution_count="40">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>ledger</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Cash</th>
<th data-quarto-table-cell-role="th">AAPL Qty</th>
<th data-quarto-table-cell-role="th">MSFT Qty</th>
<th data-quarto-table-cell-role="th">JPM Qty</th>
<th data-quarto-table-cell-role="th">XOM Qty</th>
<th data-quarto-table-cell-role="th">JNJ Qty</th>
<th data-quarto-table-cell-role="th">PG Qty</th>
<th data-quarto-table-cell-role="th">NVDA Qty</th>
<th data-quarto-table-cell-role="th">CAT Qty</th>
<th data-quarto-table-cell-role="th">HD Qty</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">JPM Price</th>
<th data-quarto-table-cell-role="th">XOM Price</th>
<th data-quarto-table-cell-role="th">JNJ Price</th>
<th data-quarto-table-cell-role="th">PG Price</th>
<th data-quarto-table-cell-role="th">NVDA Price</th>
<th data-quarto-table-cell-role="th">CAT Price</th>
<th data-quarto-table-cell-role="th">HD Price</th>
<th data-quarto-table-cell-role="th">AMZN Price</th>
<th data-quarto-table-cell-role="th">Portfolio Value</th>
<th data-quarto-table-cell-role="th">Market Value</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Date</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2024-11-01</td>
<td>217620.41</td>
<td>482</td>
<td>304</td>
<td>-397</td>
<td>0</td>
<td>615</td>
<td>836</td>
<td>0</td>
<td>412</td>
<td>365</td>
<td>...</td>
<td>222.94</td>
<td>114.95</td>
<td>160.13</td>
<td>165.10</td>
<td>135.40</td>
<td>379.63</td>
<td>392.59</td>
<td>197.93</td>
<td>782026.26</td>
<td>999646.67</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2024-11-04</td>
<td>968506.40</td>
<td>482</td>
<td>304</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>836</td>
<td>0</td>
<td>412</td>
<td>365</td>
<td>...</td>
<td>219.78</td>
<td>118.61</td>
<td>158.24</td>
<td>165.08</td>
<td>136.05</td>
<td>376.52</td>
<td>395.57</td>
<td>195.78</td>
<td>668696.83</td>
<td>1637203.23</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2024-11-05</td>
<td>1026309.84</td>
<td>482</td>
<td>304</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>836</td>
<td>0</td>
<td>0</td>
<td>365</td>
<td>...</td>
<td>221.49</td>
<td>118.96</td>
<td>158.35</td>
<td>165.76</td>
<td>139.91</td>
<td>383.37</td>
<td>400.09</td>
<td>199.50</td>
<td>517394.95</td>
<td>1543704.79</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2024-11-06</td>
<td>1403432.06</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>247.06</td>
<td>121.00</td>
<td>157.88</td>
<td>161.05</td>
<td>145.61</td>
<td>416.88</td>
<td>388.37</td>
<td>207.09</td>
<td>0.00</td>
<td>1403432.06</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2024-11-07</td>
<td>1403432.06</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>236.38</td>
<td>121.15</td>
<td>156.73</td>
<td>163.41</td>
<td>148.88</td>
<td>408.21</td>
<td>399.44</td>
<td>210.05</td>
<td>0.00</td>
<td>1403432.06</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2025-04-22</td>
<td>1403432.06</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>235.59</td>
<td>108.30</td>
<td>157.75</td>
<td>167.88</td>
<td>98.89</td>
<td>291.17</td>
<td>354.43</td>
<td>173.18</td>
<td>0.00</td>
<td>1403432.06</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2025-04-23</td>
<td>1403432.06</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>240.88</td>
<td>107.37</td>
<td>155.38</td>
<td>165.73</td>
<td>102.71</td>
<td>295.77</td>
<td>356.42</td>
<td>180.60</td>
<td>0.00</td>
<td>1403432.06</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2025-04-24</td>
<td>1403432.06</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>244.64</td>
<td>108.63</td>
<td>154.93</td>
<td>159.53</td>
<td>106.43</td>
<td>306.86</td>
<td>359.64</td>
<td>186.54</td>
<td>0.00</td>
<td>1403432.06</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2025-04-25</td>
<td>1403432.06</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>243.55</td>
<td>108.57</td>
<td>154.58</td>
<td>161.02</td>
<td>111.01</td>
<td>306.45</td>
<td>357.58</td>
<td>188.99</td>
<td>0.00</td>
<td>1403432.06</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2025-04-28</td>
<td>1403432.06</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>...</td>
<td>243.22</td>
<td>108.63</td>
<td>155.35</td>
<td>161.85</td>
<td>108.73</td>
<td>307.06</td>
<td>356.92</td>
<td>187.70</td>
<td>0.00</td>
<td>1403432.06</td>
</tr>
</tbody>
</table>

<p>120 rows Ã— 23 columns</p>
</div>
</div>
</div>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "î§‹";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>